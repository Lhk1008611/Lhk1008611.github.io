<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Redis/RedisBusinessScenarios">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">基于 Redis 的业务场景 | HankLay 的个人主页</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://lhk1008611.github.io/docs/Redis/RedisBusinessScenarios"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="基于 Redis 的业务场景 | HankLay 的个人主页"><meta data-rh="true" name="description" content="- 短信登录"><meta data-rh="true" property="og:description" content="- 短信登录"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://lhk1008611.github.io/docs/Redis/RedisBusinessScenarios"><link data-rh="true" rel="alternate" href="https://lhk1008611.github.io/docs/Redis/RedisBusinessScenarios" hreflang="zh"><link data-rh="true" rel="alternate" href="https://lhk1008611.github.io/docs/Redis/RedisBusinessScenarios" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.db39acd3.css">
<link rel="preload" href="/assets/js/runtime~main.6d6f6b8c.js" as="script">
<link rel="preload" href="/assets/js/main.31e09b09.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/favicon.ico" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/favicon.ico" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">首页</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">文档</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/Lhk1008611" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">个人简历</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/java">Java</a><button aria-label="打开/收起侧边栏菜单「Java」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/mq">MQ</a><button aria-label="打开/收起侧边栏菜单「MQ」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/mysql">MySQL</a><button aria-label="打开/收起侧边栏菜单「MySQL」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/linux">Linux</a><button aria-label="打开/收起侧边栏菜单「Linux」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/ssm">SSM</a><button aria-label="打开/收起侧边栏菜单「SSM」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/redis">Redis</a><button aria-label="打开/收起侧边栏菜单「Redis」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Redis/RedisInstall">Redis 的安装及启动</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Redis/RedisBasic">Redis 基础</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Redis/RedisBusinessScenarios">基于 Redis 的业务场景</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/dubbo">Dubbo</a><button aria-label="打开/收起侧边栏菜单「Dubbo」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/docker">Docker</a><button aria-label="打开/收起侧边栏菜单「Docker」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/spring-cloud">Spring Cloud</a><button aria-label="打开/收起侧边栏菜单「Spring Cloud」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/cloud-native">Cloud Native</a><button aria-label="打开/收起侧边栏菜单「Cloud Native」" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/redis"><span itemprop="name">Redis</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">基于 Redis 的业务场景</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>基于 Redis 的业务场景</h1><ul><li><p>短信登录</p><ul><li>Redis session 共享应用</li></ul></li><li><p>查询缓存</p><ul><li>缓存使用技巧</li><li>缓存雪崩、穿透的解决</li></ul></li><li><p>点赞功能</p><ul><li>基于 Set 的点赞列表</li><li>基于 SortedSet 的点赞排行榜，类似于微信朋友圈的点赞排行榜</li></ul></li><li><p>优惠券秒杀</p><ul><li>Redis 的计数器<code>INCR</code>、Lua 脚本</li><li>Redis 分布式锁</li><li>Redis 的三种消息队列</li></ul></li><li><p>好友关注</p><ul><li>基于 Set 集合的关注、取关、共同关注、消息推送等功能</li></ul></li><li><p>附近的商家</p><ul><li>Redis 的 GeoHash 的应用</li></ul></li><li><p>用户签到</p><ul><li>Redis 的 BitMap 数据统计功能</li></ul></li><li><p>UV 统计</p><ul><li>Redis 的 HyperLogLog 的统计功能</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-短信登录">1. 短信登录<a class="hash-link" href="#1-短信登录" title="标题的直接链接">​</a></h2><p><img loading="lazy" alt="image-20240615102019478" src="/assets/images/image-20240615102019478-65efd15a37fe4fe91ba03601906b8d65.png" width="1397" height="687" class="img_ev3q"></p><ul><li>基于 session 登录会在 cookie 中存储一个 session_id ，校验登录态时通过 cookie 携带这个 session_id 获取 session 中的登录信息<ul><li>因此只需将用户信息保存到 session 中即可，无需返回多余登录凭证到前端，登录过后后续再发送一个获取当前登录用户信息的请求即可完成完整的登录功能</li><li>前端发送请求时，部分请求都需要进行校验登录态，因此可以将校验登录态功能写在拦截器里拦截这些请求，并在前置拦截器中将用户的信息保存在 ThreadLocal 里面，可以保证线程的安全；在后置拦截器里销毁 ThreadLocal 中的用户信息</li></ul></li><li>ThreadLocal<ul><li>ThreadLocal 是 Java 中的一个类，它提供线程局部变量。这些变量在每个线程中都有自己独立的副本，因此对于不同的线程来说，<strong>即使变量名相同，它们也不会共享同一份数据</strong>。这使得在多线程环境下，每个线程都可以拥有该变量的一个独立实例，从而避免了并发访问的冲突问题，简化了线程安全的管理</li><li>特性<ul><li>线程隔离：每个线程持有一个 ThreadLocal 变量的独立副本，因此在不同线程中对 ThreadLocal 变量的操作互不影响，实现了线程间数据的隔离。</li><li>内存管理：ThreadLocal 会在线程结束时自动清除与该线程相关的变量副本，有助于防止内存泄漏，但需要注意的是，如果线程池中的线程是复用的，则需要显式清理 ThreadLocal 变量以避免潜在的内存泄漏</li></ul></li><li>应用场景<ul><li>当某个数据以线程为作用域，且不希望其在多线程间共享时，可以使用 ThreadLocal</li><li>在进行对象跨层传递时，使用 ThreadLocal 可以减少参数传递，简化代码</li><li>事务管理、数据库连接或会话管理等场景中，可以利用 ThreadLocal 存储线程特定的信息</li></ul></li></ul></li><li>短信发送验证码到手机需要<strong>调用短信发送的 API</strong>，例如：阿里云市场中的短信服务<ul><li>验证码可以存储在 session 中或者 redis 中并设置过期时间实现验证码的校验和超时失效功能</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="session-共享问题">session 共享问题<a class="hash-link" href="#session-共享问题" title="标题的直接链接">​</a></h3><ul><li><p>多台 Tomcat 并不共享 session 存储空间，当请求切换到不同 tomcat 服务时就会导致数据丢失的问题。</p><ul><li>可以使用 redis 来替代 session 存储用户信息，因为 redis 满足以下条件<ul><li>数据共享</li><li>内存存储</li><li>key、value结构</li></ul></li></ul><p><img loading="lazy" alt="image-20240619120924796" src="/assets/images/image-20240619120924796-4b7713cabf2e546e4e4186b5bf9bcf45.png" width="1164" height="510" class="img_ev3q"></p></li><li><p>基于 redis 实现共享 session 登录</p><ul><li>验证码以 string 结构存入 redis 中，key 可为<code>业务名:手机号</code>，并设置过期时间</li><li>用户信息以 hash 结构存入 redis 中，key 可为<code>业务名:随机 token（uuid）</code>，并设置过期时间（session 是 30 min 过期），token 需要返回给前端，前端在请求头中<code>authorization</code> 字段中设置 token，每次请求就会携带上 token ，并在拦截器中更新 token 对应的 key 的过期时间达到刷新的 session 效果</li></ul></li><li><p>Redis 代替 session 需要考虑的问题:</p><ul><li>选择合适的数据结构</li><li>选择合适的 key</li><li>选择合适的存储粒度（去除敏感信息，只保存需要的信息）</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="登录拦截器优化">登录拦截器优化<a class="hash-link" href="#登录拦截器优化" title="标题的直接链接">​</a></h3><ul><li><p>问题</p><ul><li>不是所有请求都会经过上面的拦截器进行登录态校验，进行 token 过期时间更新，比如用户一直在访问不需要登录验证的页面，超过时间就会需要重新登录</li></ul></li><li><p>解决方案</p><p><img loading="lazy" alt="image-20240619131907173" src="/assets/images/image-20240619131907173-18a2c279986beac42cee34ba4d90ea31.png" width="1332" height="466" class="img_ev3q"></p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-查询缓存">2. 查询缓存<a class="hash-link" href="#2-查询缓存" title="标题的直接链接">​</a></h2><ul><li><p>缓存就是数据交换的缓冲区( 称作 Cache )，是存贮数据的临时地方，一般读写性能较高</p><ul><li>缓存的作用<ul><li>降低后端负载提高读写效率，降低</li><li>响应时间</li></ul></li><li>缓存的成本<ul><li>数据一致性成本（缓存与数据库数据不一致）</li><li>代码维护成本</li><li>运维成本</li></ul></li></ul><p><img loading="lazy" alt="image-20240619132557023" src="/assets/images/image-20240619132557023-695b0f15ce82bc67a35a21a2e3fcb35c.png" width="1204" height="485" class="img_ev3q"></p></li><li><p>缓存作用模型，可以根据此模型在 redis 中添加缓存数据</p><p><img loading="lazy" alt="image-20240619133109159" src="/assets/images/image-20240619133109159-532a260e89af7ae24092b8c1487c190c.png" width="510" height="557" class="img_ev3q"></p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="缓存更新策略">缓存更新策略<a class="hash-link" href="#缓存更新策略" title="标题的直接链接">​</a></h3><table><thead><tr><th align="center"></th><th>内存淘汰</th><th>超时剔除（过期淘汰）</th><th>主动更新</th></tr></thead><tbody><tr><td align="center">说明</td><td>不用自己维护，利用Redis的内存淘汰机制，当内存不足时自动淘汰部分数据下次查询时更新缓存</td><td>给缓存数据添加 TTL 时间，到期后自动删除缓存。下次查询时更新缓存。</td><td>编写业务逻辑，在修改数据库的同时，更新缓存。</td></tr><tr><td align="center">一致性</td><td>差</td><td>一般</td><td>好</td></tr><tr><td align="center">维护成本</td><td>无</td><td>低</td><td>高</td></tr></tbody></table><ul><li><strong>缓存更新策略的最佳实践方案</strong><ul><li>低一致性需求: 使用内存淘汰机制。例如店铺类型的查询缓存</li><li>高一致性需求: 主动更新（<code>Cache Aside Pattern</code>），并以超时剔除作为兜底方案。例如店铺详情查询的缓存<ul><li>读操作：<ul><li>缓存命中则直接返回</li><li>缓存未命中则查询数据库，并写入缓存，设定超时时间</li></ul></li><li>写操作:<ul><li>先写数据库，然后再删除缓存</li><li>要确保数据库与缓存操作的原子性</li></ul></li></ul></li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="主动更新策略">主动更新策略<a class="hash-link" href="#主动更新策略" title="标题的直接链接">​</a></h4><ol><li><code>Cache Aside Pattern</code>: 由缓存的调用者，在<strong>更新数据库的同时更新缓存</strong><ul><li>需要人工编码，开发人员可控，一般开发时使用该策略</li></ul></li><li><code>Read/Write Through Pattern</code>: 缓存与数据库整合为一个服务，<strong>由服务来维护一致性</strong>。调用者调用该服务，无需关心缓存一致性问题。<ul><li>市面上很少存在这样的服务，即使有开发人员也不太好对服务进行维护</li></ul></li><li><code>Write Behind cachingPattern</code>: 调用者只操作缓存，<strong>由其它线程异步的将缓存数据持久化到数据库</strong>，保证最终一致<ul><li>异步可以大大提高系统性能</li><li>维护异步线程成本较高，且数据一致性问题依然存在，考虑到 redis 宕机后缓存中的数据还未更新到数据库还会导致数据可靠性问题</li></ul></li></ol><ul><li>在更新缓存时需要考虑的问题<ol><li>删除缓存还是更新缓存?<ul><li>更新缓存: 每次更新数据库都更新缓存，无效写操作较多</li><li>删除缓存: 更新数据库时让缓存失效，查询时再更新缓存</li></ul></li><li>如何保证缓存与数据库的操作的同时成功或失败?<ul><li>单体系统，将缓存与数据库操作放在一个事务</li><li>分布式系统，利用 TCC 等分布式事务方案</li></ul></li><li>更新时先操作缓存还是先操作数据库?<ul><li>先删除缓存，再操作数据库</li><li>先操作数据库，再删除缓存<ul><li>两种都存在线程安全问题，第二种出现线程安全问题的情况概率更低</li></ul></li></ul></li></ol></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="缓存穿透">缓存穿透<a class="hash-link" href="#缓存穿透" title="标题的直接链接">​</a></h3><ul><li><p>缓存穿透是指<strong>客户端请求的数据在缓存中和数据库中都不存在</strong>，这样缓存永远不会生效，这些请求都会打到数据库，给数据库带来压力</p></li><li><p>常见解决方案</p><ul><li><p><strong>缓存空对象（null）</strong></p><ul><li>优点: 实现简单，维护方便</li><li>缺点:<ul><li>额外的内存消耗</li><li>可能造成短期的不一致</li></ul></li></ul><p><img loading="lazy" alt="image-20240620172649090" src="/assets/images/image-20240620172649090-f10b8e6eacfc9c835d17bd9f1f994f97.png" width="396" height="489" class="img_ev3q"></p></li><li><p><strong>布隆过滤</strong></p><ul><li>布隆过滤器由一个位数组（Bit Array）和一组哈希函数（Hash Functions）组成</li><li>将查询元素通过同样的多个哈希函数进行哈希运算，产生多个哈希值。检查位数组中这些哈希值对应的位置是否全部为 1。<ul><li>如果全部为 1，说明该元素可能在集合中（存在一定的误判率）</li><li>如果有任意一个位置为 0，说明该元素一定不在集合中</li></ul></li><li>优点: 内存占用较少，没有多余 key</li><li>缺点:<ul><li>实现较复杂（redis 提供的 bitmap 可以实现布隆过滤）</li><li>存在误判可能</li></ul></li></ul><p><img loading="lazy" alt="image-20240620172919293" src="/assets/images/image-20240620172919293-2c08bb30a6456a5e234a7a1996372a62.png" width="412" height="481" class="img_ev3q"></p></li></ul></li><li><p>其他措施</p><ul><li>增强 id 的复杂度，避免被猜测 id 规律，做好这些数据的基础格式校验</li><li>加强用户权限校验</li><li>做好热点参数的限流</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="缓存雪崩">缓存雪崩<a class="hash-link" href="#缓存雪崩" title="标题的直接链接">​</a></h3><ul><li><p>缓存雪崩是指<strong>在同一时段大量的缓存 key 同时失效</strong>或者 <strong>Redis 服务宕机，导致大量请求到达数据库</strong>，带来巨大压力，可能导致数据库宕机</p><p><img loading="lazy" alt="image-20240621182226091" src="/assets/images/image-20240621182226091-78867ecfe2f9b2761048ddf251e239a2.png" width="885" height="491" class="img_ev3q"></p></li><li><p>解决方案</p><ul><li>给不同的 Key 的 TTL 添加随机值<ul><li>保证缓存数据不再同一时间全部失效</li></ul></li><li>利用 Redis 集群提高服务的可用性<ul><li>避免 Redis 服务的宕机</li></ul></li><li>给缓存业务添加降级限流策略<ul><li>确保 Redis 服务的宕机时，快速拒绝请求，不直接请求数据库，保证数据库安全</li></ul></li><li>给业务添加多级缓存<ul><li>例如浏览器缓存、nginx 反向代理缓存、jvm 本地缓存等</li></ul></li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="缓存击穿">缓存击穿<a class="hash-link" href="#缓存击穿" title="标题的直接链接">​</a></h3><ul><li><p>缓存击穿问题也叫热点 Key 问题，就是<strong>一个被高并发访问并且缓存重建业务较复杂的 Key 突然失效了</strong>，无数的请求访问会在瞬间给数据库带来巨大的冲击</p><p><img loading="lazy" alt="image-20240621184227173" src="/assets/images/image-20240621184227173-9348170d7f623bf90e2c3c2fbfd0d866.png" width="891" height="546" class="img_ev3q"></p></li><li><p>解决方案</p><ul><li><p>互斥锁</p><p><img loading="lazy" alt="image-20240621184623821" src="/assets/images/image-20240621184623821-1cb249d6924a89c65c0e0b00e1fe7ec1.png" width="499" height="637" class="img_ev3q"></p><ul><li>缺点：一个线程获取到锁后，其他线程会阻塞等待，性能低下</li></ul></li><li><p>逻辑过期：不给缓存数据设置 ttl，给数据添加一个逻辑过期时间字段，通过该字段判断数据是否过期</p><p><img loading="lazy" alt="image-20240621185439977" src="/assets/images/image-20240621185439977-aa4d930e103c6c1bdcbc36a3f5a3e02d.png" width="902" height="666" class="img_ev3q"></p></li></ul></li><li><p>两种方案对比</p><table><thead><tr><th>解决方案</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>互斥锁</td><td>没有额外的内存消耗<br>保证一致性<br>实现简单</td><td>线程需要等待，性能受影响<br>可能有死锁风险</td></tr><tr><td>逻辑过期</td><td>线程无需等待，性能较好</td><td>不保证一致性<br>有额外内存消耗<br>实现复杂</td></tr></tbody></table></li><li><p>如何获取和释放锁？</p><ul><li><p>通过 <code>setnx key value </code>命令达到加锁的功能</p><p><img loading="lazy" alt="image-20240625162008215" src="data:image/png;base64,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" width="587" height="97" class="img_ev3q"></p></li><li><p><code>get key</code> 获取锁</p></li><li><p><code>del key</code> 删除锁</p></li></ul></li><li><p>可以使用 <strong>Jmeter</strong> 实现多线程高并发测试、</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-优惠券秒杀">3. 优惠券秒杀<a class="hash-link" href="#3-优惠券秒杀" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="全局唯一-id">全局唯一 ID<a class="hash-link" href="#全局唯一-id" title="标题的直接链接">​</a></h3><ul><li><p>有一些业务使用数据库自增 ID 会存在一些问题</p><ul><li>ID 的规律性太明显，导致暴露一些信息</li><li>受单表数据量的限制，后续需要分表，使用自增 ID 会导致多张表出现相同的 ID</li></ul></li><li><p>全局ID生成器，是一种在分布式系统下用来生成全局唯一 ID 的工具，一般要满足下列特性:</p><ul><li>唯一性</li><li>高可用</li><li>高性能</li><li>递增性</li><li>安全性</li></ul></li><li><p>全局唯一ID生成策略:</p><ul><li>UUID<ul><li>是字符串类型，占用空间大，不满足全局单调递增</li></ul></li><li>Redis 自增</li><li>snowflake 雪花算法</li><li>数据库自增<ul><li>单独使用一张表存储自增 ID 实现全局唯一 ID</li></ul></li></ul></li><li><p>基于 Redis 自增策略实现全局唯一 ID 示例:</p><ul><li>每天一个 key，方便统计订单量</li><li>ID 构造： 时间戳 + 计数器<ul><li>符号位: 1bit，永远为 0</li><li>时间戳: 31bit，以秒为单位，可以使用 69 年</li><li>序列号: 32bit，秒内的计数器，支持每秒产生 2^32 个不同ID</li></ul></li></ul><p><img loading="lazy" alt="image-20240626230540379" src="/assets/images/image-20240626230540379-be00d75d3c2bd467e0e4311882266437.png" width="1186" height="217" class="img_ev3q"></p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@Component</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">RedisIDGenerate</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * 初始时间戳</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * LocalDateTime.of(2024, 6, 1, 0, 0, 0).toEpochSecond(ZoneOffset.UTC)</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">BEGIN_TIMESTAMP</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1717200000L</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">Integer</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">BITS</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">StringRedisTemplate</span><span class="token plain"> stringRedisTemplate</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">RedisIDGenerate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">StringRedisTemplate</span><span class="token plain"> stringRedisTemplate</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stringRedisTemplate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> stringRedisTemplate</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">generateID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token plain"> prefix</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 构造 ID 的时间戳</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">LocalDateTime</span><span class="token plain"> now </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">LocalDateTime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> timestamp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> now</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toEpochSecond</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ZoneOffset</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">UTC</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">BEGIN_TIMESTAMP</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 构造 ID 的序列号,基于 redis 的自增 ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">String</span><span class="token plain"> day </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> now</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ofPattern</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;yyyy:MM:dd&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> increment </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> stringRedisTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">opsForValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">increment</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;icr:&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> prefix </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;:id&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> day</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> timestamp </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">BITS</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> increment</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Autowired</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">RedisIDGenerate</span><span class="token plain"> redisIDGenerate</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">ExecutorService</span><span class="token plain"> executorService </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Executors</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newFixedThreadPool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">500</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">testGenerateID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">InterruptedException</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">CountDownLatch</span><span class="token plain"> countDownLatch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">CountDownLatch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">300</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Runnable</span><span class="token plain"> runnable </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">redisIDGenerate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">generateID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;order&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            countDownLatch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">countDown</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> start </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">currentTimeMillis</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">300</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            executorService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">submit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">runnable</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        countDownLatch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">await</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token comment" style="color:#999988;font-style:italic">// 等待所有子线程执行完后才执行主线程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> end </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">currentTimeMillis</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;耗时：&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">end </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> start</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="超卖问题">超卖问题<a class="hash-link" href="#超卖问题" title="标题的直接链接">​</a></h3><ul><li><p>超卖问题本质上是一种高并发情况下的线程安全问题</p><p><img loading="lazy" alt="image-20240627183141282" src="/assets/images/image-20240627183141282-6f1bcead98082590088764698f1b308b.png" width="644" height="429" class="img_ev3q"></p></li><li><p>解决方案：加锁</p><ul><li>悲观锁<ul><li>认为线程安全问题一定会发生，因此在操作数据之前先获取锁，确保线程串行执行。</li><li>例如 <code>Synchronized</code>、<code>Lock</code> 都属于悲观锁</li></ul></li><li>乐观锁<ul><li>认为线程安全问题不一定会发生，因此不加锁，只是在更新数据时去判断有没有其它线程对数据做了修改。<ul><li>如果没有修改则认为是安全的，自己才更新数据。</li><li>如果已经被其它线程修改说明发生了安全问题，此时可以重试或异常。</li></ul></li></ul></li></ul></li><li><p>乐观锁的关键是<strong>判断之前查询得到的数据是否有被修改过</strong>，常见的乐观锁有两种:</p><ul><li><p><strong>版本号</strong>：</p><ul><li>给数据添加一个 <code>version</code> 字段，每次更新数据都要修改<code>version</code>，这样就可以通过在更新 SQL 中的 where 条件上添加判断当前要修改的数据的 <code>version</code> 字段是否与数据库中真实存在的数据的<code>version</code>一致，因此在多线程的情况下，一个线程更新了数据的版本后，另外的线程也不会更新成功</li></ul><p><img loading="lazy" alt="image-20240627185014885" src="/assets/images/image-20240627185014885-d062e306e6b63afd6caa6c7071b4043c.png" width="559" height="420" class="img_ev3q"></p></li><li><p><strong>CAS 法</strong>：</p><ul><li>本质上就是将比较判断<code>version</code>字段改为比较判断数据原有字段，前提是数据中存在这样能进行比较的字段</li><li>CAS 是 “Compare and Swap”（比较与交换）的缩写，它是一种无锁算法，在多线程编程中用于实现同步原语。</li><li>CAS操作包含三个操作数：内存位置（V）、预期原值（A）和新值（B）。其执行过程如下：<ol><li>比较：首先，CAS会比较内存位置V的值与预期原值A是否相等。</li><li>交换：如果相等，则将内存位置V的值更新为新值B。如果V的值与A不相等，则不执行任何操作。</li><li>原子性：整个比较并交换的过程是一个原子操作，这意味着它不会被线程调度机制打断，保证了多线程环境下的数据一致性。</li></ol></li></ul><p><img loading="lazy" alt="image-20240627185727822" src="/assets/images/image-20240627185727822-3a1d2f20e8e2a9f4f06ed8c8224d851d.png" width="567" height="402" class="img_ev3q"></p><ul><li>CAS常用于构建 lock-free 数据结构，如无锁队列、栈等，以及原子变量（如Java中的AtomicInteger）的更新操作。</li><li>相比传统的锁机制，CAS可以减少线程间的直接竞争，降低上下文切换的开销，提高程序的并发性能。</li><li>但是，它也可能引发 <strong>ABA</strong> 问题，以及在持续竞争激烈的情况下<strong>导致大量的失败重试</strong>，从而影响性能。为此，一些算法和数据结构设计会结合版本号或者使用更复杂的同步机制来解决这些问题。</li></ul></li></ul></li><li><p>两种锁的比较</p><ul><li>悲观锁: 添加同步锁，让线程串行执行<ul><li>优点:简单粗暴</li><li>缺点:性能一般</li></ul></li><li>乐观锁: 不加锁，在更新时判断是否有其它线程在修改<ul><li>优点: 性能好</li><li>缺点: 存在成功率低的问题</li></ul></li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="一人一单">一人一单<a class="hash-link" href="#一人一单" title="标题的直接链接">​</a></h3><ul><li><p>秒杀业务中会存在一人一单的业务场景</p><ul><li>该业务场景下也会出现线程安全问题，需要控制查询订单和判断订单是否存在时只能有一个线程进入</li></ul><p><img loading="lazy" alt="image-20240701174851509" src="/assets/images/image-20240701174851509-0106f737bb02f3d8279ff2f449c9749e.png" width="839" height="400" class="img_ev3q"></p></li><li><p>解决方案</p><ul><li><p>悲观锁</p><ul><li><p>可以对用户 ID 进行加锁（<code>synchronized</code>），确保一个用户线程可以执行逻辑任务</p></li><li><p>注意：</p><ol><li><p>用户 ID 是从用户对象中获取的，每次获取到同一个用户的用户 ID 值是一样的，但是在 Java 中不是同一个用户对象的用户 ID，因此加锁会失败。</p><ul><li><p>解决方案如下，确保加锁的同一个用户的用户 ID 是唯一的</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">synchronized</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">userId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">intern</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul></li><li><p>需要确保事务提交完后再释放锁，可以将锁放在事务外面</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">synchronized</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">userId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">intern</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//基于事务的业务逻辑</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>还需要注意 spring 事务失效的情况，可以通过拿到事务的代理对象去调用事务方法解决 spring 事务失效的问题</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">//获取事务的代理对象</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">Object</span><span class="token plain"> o </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">AopContext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">currentProxy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>需要引入  AspectJ 的依赖</p><p>并在启动类上添加<code>@EnableAspectJAutoProxy(exposeProxy = true)</code></p></blockquote></li></ol></li></ul></li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="分布式锁">分布式锁<a class="hash-link" href="#分布式锁" title="标题的直接链接">​</a></h3><ul><li><p><code>synchronized</code>方案只能解决单机线程安全问题，在服务集群下就会存在分布式线程安全问题</p><p><img loading="lazy" alt="image-20240701182249922" src="/assets/images/image-20240701182249922-548423be4bf7215b5e002ba00a800928.png" width="1089" height="482" class="img_ev3q"></p></li><li><p>分布式锁：满足分布式系统或集群模式下<strong>多进程可见</strong>并且<strong>互斥</strong>的锁</p><ul><li>特性<ul><li>多进程可见</li><li>互斥</li><li>高可用</li><li>高性能</li><li>安全性</li></ul></li></ul></li><li><p>分布式锁的原理</p><p><img loading="lazy" alt="image-20240701183003184" src="/assets/images/image-20240701183003184-306ac72f03646979443304f8f245f286.png" width="1094" height="551" class="img_ev3q"></p></li><li><p>分布式锁的实现</p><table><thead><tr><th></th><th>MySQL</th><th>Redis</th><th>Zookeeper</th></tr></thead><tbody><tr><td>说明</td><td><code>SELECT FOR UPDATE</code> 是 SQL 中的一个命令，主要用于数据库事务处理中，以实现行级别的悲观锁机制（但根据数据库的具体实现和配置，也可能是表锁）</td><td></td><td></td></tr><tr><td>互斥</td><td>利用 mysql 本身的互斥锁机制</td><td>利用<code>setnx</code>这样的互斥命令</td><td>利用节点的唯一性和有序性实现互斥</td></tr><tr><td>高可用</td><td>好</td><td>好</td><td>好</td></tr><tr><td>高性能</td><td>一般</td><td>好</td><td>一般</td></tr><tr><td>安全性</td><td>断开连接，自动释放锁</td><td>利用锁超时时间，到期释放</td><td>临时节点，断开连接自动释放</td></tr></tbody></table></li></ul><ul><li><p>如何获取锁和释放锁</p><ul><li><p>获取锁</p><ul><li><p>互斥：确保只能有一个线程获取锁</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">setnx lock thread1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 给锁添加过期时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">expire lock </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 查看过期过期时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ttl lock</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>原子操作</p><ul><li>非阻塞：尝试一次，成功返回 true，失败返回false</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">set</span><span class="token plain"> lock thread1 ex </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> nx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul></li><li><p>删除锁</p><ul><li><p>手动释放：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 删除锁</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">del lock</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>超时释放：获取锁时添加一个超时时间</p></li></ul></li></ul></li><li><p>分布式锁流程</p><p><img loading="lazy" alt="image-20240701194433155" src="/assets/images/image-20240701194433155-326c96d23c58e7c83ff679591b7aca00.png" width="312" height="402" class="img_ev3q"></p></li><li><p>分布式锁误删</p><p>上面的流程在业务阻塞时间过长的情锁超时释放况下会存在锁的误删，应该在删除锁时判断锁的标识与当前线程是否一致</p><p><img loading="lazy" alt="image-20240701201602500" src="/assets/images/image-20240701201602500-73e88c1d462bfbfa4122baac905b17ef.png" width="440" height="464" class="img_ev3q"></p><ul><li><p>需要确保判断锁标识和释放锁操作的原子性，否则在判断锁标识成功后进入长时间的阻塞（例如：full gc）依然会出现锁的误删情况</p><p><img loading="lazy" alt="image-20240701204449159" src="/assets/images/image-20240701204449159-af805e8d3821d771a462b75f68995f26.png" width="1109" height="459" class="img_ev3q"></p><ul><li>解决方案<ol><li>基于 redis 的事务和乐观锁 watch 机制解决，比较复杂</li><li>Lua 脚本<ul><li>Redis 提供了 Lua 脚本功能，在一个脚本中编写多条 Redis 命令，确保多条命令执行时的原子性</li></ul></li></ol></li></ul></li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="lua-脚本">Lua 脚本<a class="hash-link" href="#lua-脚本" title="标题的直接链接">​</a></h4><ul><li><p>Redis 使用 Lua 脚本来实现操作的原子性，主要是因为Redis 服务器会将整个 Lua 脚本作为单一的命令执行，期间不会被其他命令中断。这样，脚本中的所有 Redis 命令都会在同一个 Redis 事务中执行，确保了操作的原子性。以下是使用 Lua 脚本实现原子操作的基本步骤</p><ol><li><p>编写 Lua 脚本：在 Lua 脚本中，你可以调用 <code>redis.call()</code> 或 <code>redis.pcall()</code> 来执行 Redis 命令。这些调用在执行时具有原子性。</p></li><li><p>发送脚本到 Redis：使用 <code>EVAL</code> 或 <code>EVALSHA</code> 命令将 Lua 脚本发送到 Redis 服务器执行。<code>EVALSHA</code> 是在脚本已经通过 <code>SCRIPT LOAD</code> 命令预加载到 Redis 后使用的，可以减少网络传输量。</p><p><img loading="lazy" alt="image-20240701211248096" src="/assets/images/image-20240701211248096-4e258268d610f6784878a56b8f644930.png" width="541" height="250" class="img_ev3q"></p></li><li><p>处理结果：Redis 执行完脚本后，会返回脚本执行的结果。</p></li></ol></li><li><p>基于 Lua 脚本实现 redis 判断锁释放锁操作原子性</p><div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-- unlock.lua</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- keys[1] 是传入的 key 数组，argv[1] 是传入的其他参数数组</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- 比较当前线程是否一致与锁的标识</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (redis.call(&#x27;get&#x27;,keys[1]) == argv[1]) then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return redis.call(&#x27;del&#x27;,keys[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return 0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">ILock</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tryLock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token plain"> lockKey</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> requestId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> expireTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">unlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token plain"> lockKey</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> requestId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">java</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">util</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name">Collections</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">java</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">util</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">concurrent</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name">TimeUnit</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">com</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">lhk</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">redis_study</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">lock</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name">ILock</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">org</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">springframework</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">core</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">io</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name">ClassPathResource</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">org</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">springframework</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">data</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">redis</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">core</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name">StringRedisTemplate</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">org</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">springframework</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">data</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">redis</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">core</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">script</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name">DefaultRedisScript</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">RedisLock</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">implements</span><span class="token plain"> </span><span class="token class-name">ILock</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">LOCK_PREFIX</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;lock:&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">StringRedisTemplate</span><span class="token plain"> stringRedisTemplate</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">DefaultRedisScript</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Long</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UNLOCK_SCRIPT</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token constant" style="color:#36acaa">UNLOCK_SCRIPT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">DefaultRedisScript</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token constant" style="color:#36acaa">UNLOCK_SCRIPT</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setLocation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ClassPathResource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;unlock.lua&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token constant" style="color:#36acaa">UNLOCK_SCRIPT</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setResultType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Long</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">RedisLock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">StringRedisTemplate</span><span class="token plain"> stringRedisTemplate</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stringRedisTemplate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> stringRedisTemplate</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tryLock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token plain"> lockKey</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> requestId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> expireTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Boolean</span><span class="token plain"> ifAbsent </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> stringRedisTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">opsForValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setIfAbsent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">LOCK_PREFIX</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> lockKey</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> requestId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> expireTime</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">TimeUnit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">MILLISECONDS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">Boolean</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">TRUE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">equals</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ifAbsent</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">unlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token plain"> lockKey</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> requestId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stringRedisTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token constant" style="color:#36acaa">UNLOCK_SCRIPT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">Collections</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">singletonList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">LOCK_PREFIX</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> lockKey</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                requestId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//    @Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//    public void unlock(String lockKey, String requestId) {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//        String id = stringRedisTemplate.opsForValue().get(LOCK_PREFIX + lockKey);</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//        if (id.equals(requestId)){</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//            stringRedisTemplate.delete(LOCK_PREFIX + lockKey);</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//        }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//        System.out.println(&quot;unlock&quot;);</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//    }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="分布式锁优化">分布式锁优化<a class="hash-link" href="#分布式锁优化" title="标题的直接链接">​</a></h4><ul><li><p>上述基于 string 类型的 setnx 实现的锁基本可以满足大多数情况下的锁要求</p></li><li><p>但是基于 setnx 实现的分布式锁依然存在问题</p><ol><li>不可重入<ul><li>同一个线程无法多次获取同一把锁</li></ul></li><li>不可重试<ul><li>获取锁只尝试一次就返回 false，没有重试机制</li></ul></li><li>超时释放<ul><li>锁超时释放虽然可以避免死锁，但如果是业务执行耗时较长，也会导致锁释放，存在安全隐患</li></ul></li><li>主从一致性<ul><li>如果Redis提供了主从集群主从同步存在延迟，当主添加锁成功后宕机时，此时从同步主的锁数据失败，其他线程又可以添加锁，则会出现线程安全问题</li></ul></li></ol></li><li><p>上述的这些问题要解决比较麻烦，因此不推荐自己实现，可以使用市面上成熟的框架，例如 Redisson</p></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="redisson">Redisson<a class="hash-link" href="#redisson" title="标题的直接链接">​</a></h4><ul><li><p>官网：<a href="https://redisson.org/" target="_blank" rel="noopener noreferrer">Redisson: Easy Redis Java client and Real-Time Data Platform</a></p></li><li><p>Redisson 是一个在 Redis 的基础上实现的 Java 驻内存数据网格(In-Memory Data Grid)。它不仅提供了一系列的分布式的 Java 常用对象，还提供了许多分布式服务，其中就包含了各种分布式锁的实现。</p></li><li><p>引入依赖</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.redisson</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">redisson</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">3.32.0</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>配置 Redisson</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Bean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">RedissonClient</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">redissonClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">IOException</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Config</span><span class="token plain"> config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">useSingleServer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setAddress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;redis://127.0.0.1:6379&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setPassword</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;12356&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">Redisson</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>测试锁</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Autowired</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">RedissonClient</span><span class="token plain"> redissonClient</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">testRedisson</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">InterruptedException</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 获取可重入锁</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">RLock</span><span class="token plain"> lock </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> redissonClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getLock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;myLock&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 尝试获取锁,参数分别是:获取锁的最大等待时间(期间会重试)，锁自动释放时间，时间单位</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> tryLock </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lock</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">tryLock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">TimeUnit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">SECONDS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 获取锁成功</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tryLock</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;获取锁成功&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Exception</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">printStackTrace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token keyword" style="color:#00009f">finally</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">// 释放锁</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                lock</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">unlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><h5 class="anchor anchorWithStickyNavbar_LWe7" id="redisson-可重入锁">Redisson 可重入锁<a class="hash-link" href="#redisson-可重入锁" title="标题的直接链接">​</a></h5><ul><li><p>锁重入</p><ul><li><p>一个线程可以多次获取锁</p></li><li><p>例：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">RLock</span><span class="token plain"> lock </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> redissonClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getLock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;myLock&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">method1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">InterruptedException</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> tryLock </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lock</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">tryLock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">tryLock</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;方法一获取锁失败&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;方法一获取锁成功&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;执行业务一&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">method2</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Exception</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">printStackTrace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token keyword" style="color:#00009f">finally</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;方法一释放锁&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            lock</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">unlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">method2</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">InterruptedException</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> tryLock </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lock</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">tryLock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">tryLock</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;方法二获取锁失败&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;执行业务二&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Exception</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">printStackTrace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token keyword" style="color:#00009f">finally</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;方法二释放锁&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            lock</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">unlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul></li><li><p>可重入锁的基本实现原理：当锁已经存在时，再次获取锁时判断锁标识是否同一个线程的，为真就可以再次获取这把锁，并对锁的重入次数进行一个计数（通常是有一个用于计数的字段），每重入一次就加一，每次释放就减一</p></li><li><p>Redisson 可重入锁使用 redis 的 hash 结构并基于 lua 脚本（确保获取锁和释放锁的原子性）实现可重入锁，Redisson 会在 hash 结构的锁中维护锁标识和锁的重入次数计数器</p><ul><li><p>实现流程</p><p><img loading="lazy" alt="image-20240702224632736" src="/assets/images/image-20240702224632736-dab69ebfe31ec9ba5e60fd8a92293214.png" width="520" height="555" class="img_ev3q"></p></li></ul></li><li><p>自定义获取锁的 lua 脚本</p><div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">local key = KEYS[1]; -- 锁的 key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local threadId = ARGV[1]; -- 线程唯一标识</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local releaseTime = ARGV[2]; -- 锁自动解锁时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- 判断锁是否存在</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- 不存在，获取锁</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if(redis.call(&#x27;exists&#x27;,key) == 0) then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    redis.call(&#x27;hset&#x27;,key,threadId,&#x27;1&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- 设置过期时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    redis.call(&#x27;expire&#x27;,key,releaseTime);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- 锁存在，判断是否是当前线程获取锁</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if(redis.call(&#x27;hexists&#x27;,key,threadId) == 1) then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- 是同一个线程，重入次数+1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    redis.call(&#x27;hincrby&#x27;,key,threadId,1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- 设置过期时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    redis.call(&#x27;expire&#x27;,key,releaseTime);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return 0;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>自定义释放锁的 lua 脚本</p><div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">local key = KEYS[1]; -- 锁的 key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local threadId = ARGV[1]; -- 线程唯一标识</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local releaseTime = ARGV[2]; -- 锁自动解锁时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- 判断锁是否是当前线程的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- 如果不是，直接返回</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if(redis.call(&#x27;hexists&#x27;,key,threadId) == 0)then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return nil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- 锁是否是当前线程的,重入次数减一</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local count = redis.call(&#x27;hincrby&#x27;,key,threadId,-1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- 判断锁重入次数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- 次数大于 0 说明不能释放锁</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (count &gt; 0) then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- 设置过期时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    redis.call(&#x27;expire&#x27;,key,releaseTime);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return nil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- 次数等于 0 说明可以释放锁</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    redis.call(&#x27;del&#x27;,key);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return nil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>查看 Redisson 底层获取锁、释放锁源码</p><p><img loading="lazy" alt="image-20240703000624834" src="/assets/images/image-20240703000624834-18d3e9fb53d506b748a6fde12f1e1539.png" width="1292" height="309" class="img_ev3q"></p><p><img loading="lazy" alt="image-20240703001346929" src="/assets/images/image-20240703001346929-dc0186b773e329baadf89aff7213c1ac.png" width="970" height="690" class="img_ev3q"></p></li></ul><h5 class="anchor anchorWithStickyNavbar_LWe7" id="redisson-锁重试机制和-watchdog-看门狗机制">Redisson 锁重试机制和 WatchDog （看门狗）机制<a class="hash-link" href="#redisson-锁重试机制和-watchdog-看门狗机制" title="标题的直接链接">​</a></h5><ul><li>锁重试<ul><li>Redisson 的 <code>tryLock</code> 方法可以指定一个 <code>waitTime</code> 参数表示获取锁的最大等待时间，在这个时间内若是线程没有获取到锁会尝试重试获取锁<ul><li>此处的重试获取锁是利用 redis 的发布订阅功能进行重试，即线程没获取到锁不是直接重试获取锁，而是先订阅当前锁是否释放，释放后若最大等待时间还足够，再进行重试，具体需要阅读源码</li></ul></li></ul></li><li>锁超时释放问题：业务未执行完毕锁就自动释放了<ul><li>Redisson 中使用 WatchDog （看门狗）机制实现了锁的自动续期，达到锁永不过期的目的，解决锁超时释放的问题，只有在释放锁的时候会取消定时自动续期锁<ul><li>Redisson 的 <code>tryLock</code> 方法不指定 <code>leaseTime</code> 参数就可以达到上述功能</li></ul></li><li>看门狗（Watchdog）模式:<ul><li>在获取锁的同时，启动一个后台线程（看门狗）。
看门狗负责在锁到期前定期（比如锁剩余时间的 1/3 ）向Redis发送命令，延长锁的过期时间。
这要求锁的持有者在完成工作前保持活跃，并能及时终止看门狗，避免无谓的续期。</li></ul></li></ul></li></ul><p><img loading="lazy" alt="image-20240703005327539" src="/assets/images/image-20240703005327539-1f9fdaddad74fa4096e2f266811fbffa.png" width="1181" height="540" class="img_ev3q"></p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="redisson-的-multilock">Redisson 的 multiLock<a class="hash-link" href="#redisson-的-multilock" title="标题的直接链接">​</a></h5><ul><li>分布式锁主从一致性问题<ul><li>分布式锁主从一致性问题是指在基于Redis的主从架构中，由于主节点和从节点之间数据同步的延迟，可能导致分布式锁的功能失效，从而影响系统的数据一致性和业务逻辑正确性。</li><li>具体来说，这个问题主要体现在以下几个方面：<ol><li>锁信息同步延迟：在主从架构的Redis集群中，客户端通常会在主节点上获取锁，然后主节点会将锁的信息异步复制到从节点。但是，这个复制过程并非瞬时完成的，存在一定的延迟。如果在这段时间内主节点发生故障，并且一个从节点被提升为主节点，新主节点可能还没有接收到之前的锁信息，就会造成锁丢失，即原本已被锁定的资源可能被其他客户端误认为未上锁而再次获取锁，导致并发访问冲突。</li><li>锁续期与失效问题：在锁的有效期内，如果客户端定期续期来保持锁的状态，但主节点故障发生在续期操作之前，那么即使客户端在原主节点成功续期，新的主节点也不会有关于这个锁的任何信息，导致锁提前失效。</li><li>锁释放问题：客户端在主节点上成功释放了锁，但由于主从同步延迟，从节点上还未接收到释放锁的操作，此时若主节点故障，从节点晋升成主节点后，该锁仍然被视为有效，导致锁无法被其他客户端获取。</li></ol></li></ul></li><li>为了解决这些问题，Redisson 等客户端库提供了多种策略，如 <code>multiLock</code>（联锁）、使用 Lua 脚本保证操作的原子性、锁续期机制等，来增强分布式锁的可靠性和一致性。特别是 <code>multiLock</code> 方案，可以通过在多个 Redis 节点上同时加锁，增加锁操作的鲁棒性，确保在主节点故障时，依然能够维持锁的正确状态</li><li><code>multiLock</code>原理<ul><li>多个独立的 Resis 节点，必须在所有节点都获取重入锁，才算获取锁成功</li><li>缺点<ul><li>运维成本高、实现复杂</li></ul></li></ul></li></ul><h5 class="anchor anchorWithStickyNavbar_LWe7" id="redisson-分布式锁原理">Redisson 分布式锁原理<a class="hash-link" href="#redisson-分布式锁原理" title="标题的直接链接">​</a></h5><ul><li>可重入锁: 利用 hash 结构记录线程 id 和重入次数</li><li>可重试: 利用信号量和 PubSub 功能实现等待、唤醒，获取
锁失败的重试机制</li><li>锁超时续约: 利用 watchDog，每隔一段时间( <code>releaseTime
/3</code>)，重置超时时间</li><li>锁的主从一致性：Redisson 的 multiLock 可以解决</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="秒杀业务优化">秒杀业务优化<a class="hash-link" href="#秒杀业务优化" title="标题的直接链接">​</a></h3><ul><li>秒杀业务的优化思路<ul><li>先利用 Redis 和 lua 脚本完成库存余量、一人一单判断，完成抢单业务</li><li>再将下单业务放入阻塞队列，利用独立线程异步下单<ul><li>可以使用 <code>java.util.concurrent</code> 包下的 <code>BlockingQueue</code> 阻塞队列来实现独立线程异步下单</li></ul></li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="redis-实现消息队列">Redis 实现消息队列<a class="hash-link" href="#redis-实现消息队列" title="标题的直接链接">​</a></h3><ul><li><p>消息队列 (Message Queue)，字面意思就是存放消息的队列。最简单的消息队列模型包括 3 个角色:</p><ul><li>消息队列: 存储和管理消息，也被称为消息代理(Message Broker)</li><li>生产者: 发送消息到消息队列</li><li>消费者: 从消息队列获取消息并处理消息</li></ul><p><img loading="lazy" alt="image-20240704000129324" src="/assets/images/image-20240704000129324-8df075d570d7ef8604ea06fba67a37c9.png" width="1021" height="325" class="img_ev3q"></p></li><li><p>Redis 提供了三种不同的方式来实现消息队列:</p><ol><li>list 结构: 基于 List 结构模拟消息队列</li><li>PubSub: 基本的点对点消息模型</li><li>Stream: 比较完善的消息队列模型</li></ol></li></ul><table><thead><tr><th></th><th>List</th><th>Pubsub</th><th>Stream</th></tr></thead><tbody><tr><td>消息持久化</td><td>支持</td><td>不支持</td><td>支持</td></tr><tr><td>阻塞读取</td><td>支持</td><td>支持</td><td>支持</td></tr><tr><td>消息堆积处理</td><td>受限于内存空间，可以利用多消费者加快</td><td>受限于消费者缓冲区</td><td>受限于队列长度，可以利用消费者组提高消费速度，减少堆积</td></tr><tr><td>消息确认机制</td><td>不支持</td><td>不支持</td><td>支持</td></tr><tr><td>消息回湖</td><td>不支持</td><td>不支持</td><td>支持</td></tr></tbody></table><ul><li>这里的持久化是基于 Redis 的持久化，不能确保消息万无一失</li><li>这里的消息确认机制只支持消费者的确认机制，不支持生产者的确认机制</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-基于list-结构模拟消息队列">1. 基于List 结构模拟消息队列<a class="hash-link" href="#1-基于list-结构模拟消息队列" title="标题的直接链接">​</a></h4><ul><li><p>队列是入口和出口不在一边，因此我们可以利用: <code>LPUSH</code>  结合 <code>RPOP</code>、或者 <code>RPUSH</code> 结合 <code>LPOP</code> 来实现</p></li><li><p>不过要注意的是，当队列中没有消息时 <code>RPOP</code> 或 <code>LPOP</code> 操作会返回 <code>null</code>，并不像 JVM 的阻塞队列那样会阻塞并等待消息。</p><ul><li>因此可以使用 <code>BRPOP</code> 或者 <code>BLPOP</code> 来实现阻塞效果（有元素就取，无元素就等）</li></ul></li><li><p>优点:</p><ul><li>利用 Redis 存储，不受限于 JVM 内存上限</li><li>基于 Redis 的持久化机制，数据安全性有保证</li><li>可以满足消息有序性</li></ul></li><li><p>缺点:</p><ul><li>无法避免消息丢失</li><li>只支持单消费者</li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-基于-pubsub-的消息队列">2. 基于 PubSub 的消息队列<a class="hash-link" href="#2-基于-pubsub-的消息队列" title="标题的直接链接">​</a></h4><ul><li><p>Pubsub (发布订阅)是 Redis2.0 版本引入的消息传递模型。顾名思义，消费者可以订阅一个或多个 channel，生产者向对应 channel 发送消息后，所有订阅者都能收到相关消息。</p></li><li><p>相关命令</p><ul><li><code>PUBLISH channel msg</code> : 向一个频道发送消息</li><li><code>SUBSCRlBE channel [channel]</code>: 订一个或多个频道</li><li><code>RSUBSCRlBE pattern [pattern]</code>: 订阅与 pattern 格式匹配的所有频道</li></ul></li><li><p>优点:</p><ul><li>采用发布订阅模型，支持多生产、多消费</li></ul></li><li><p>缺点:</p><ul><li>不支持数据持久化</li><li>无法避免消息丢失</li><li>消息堆积有上限，超出时数据丢失</li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-基于-stream-的消息队列">3. 基于 Stream 的消息队列<a class="hash-link" href="#3-基于-stream-的消息队列" title="标题的直接链接">​</a></h4><h5 class="anchor anchorWithStickyNavbar_LWe7" id="31-单消费模式">3.1 单消费模式<a class="hash-link" href="#31-单消费模式" title="标题的直接链接">​</a></h5><ul><li><p>Stream 是 Redis 5.0 引入的一种新数据类型，可以实现一个功能非常完善的消息队列</p></li><li><p>相关命令</p><ul><li><p>官方文档：<a href="https://redis.io/docs/latest/commands/?group=stream" target="_blank" rel="noopener noreferrer">stream| Docs (redis.io)</a></p></li><li><p><code>xadd</code>：发消息</p><p><img loading="lazy" alt="image-20240704202956719" src="/assets/images/image-20240704202956719-1a7b22f233813a5e86161d454741e206.png" width="1054" height="184" class="img_ev3q"></p><ul><li><p>例：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 发消息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">xadd mystream * message hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 查看消息数量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">xlen mystream</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul></li><li><p><code>xread</code>：读消息</p><p><img loading="lazy" alt="image-20240704204159511" src="/assets/images/image-20240704204159511-5ca7c3202902b310354cf3179f6630d1.png" width="1420" height="197" class="img_ev3q"></p><ul><li><p>例：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 读消息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">xread count </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> streams mystream </span><span class="token number" style="color:#36acaa">0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>当指定起始 ID 为 <code>$</code> 时，代表读取最新的消息，如果我们处理一条消息的过程中，又有超过1条以上的消息到达队列，则下次获取时也只能获取到最新的一条，会出现漏读消息的问题</p></li></ul></li></ul></li><li><p>STREAM 类型消息队列的 <code>XREAD</code> 命令特点:</p><ul><li>消息可回溯，消息对保存在 stream 数据结构中</li><li>一个消息可以被多个消费者读取</li><li>可以阻塞读取</li><li>有消息漏读的风险</li></ul></li></ul><h5 class="anchor anchorWithStickyNavbar_LWe7" id="32-消费者组">3.2 消费者组<a class="hash-link" href="#32-消费者组" title="标题的直接链接">​</a></h5><ul><li><p>消费者组 (Consumer Group) : 将多个消费者划分到一个组中，监听同一个队列。具备下列特点:</p><ol><li>消息分流（解决消息堆积问题）<ul><li>队列中的消息会分流给组内的不同消费者，而不是重复消费，从而加快消息处理的速度</li></ul></li><li>消息标示（解决消息漏读问题）<ul><li>消费者组会维护一个标示，记录最后一个被处理的消息，哪怕消费者宕机重启，还会从标示之后读取消息。确保每一个消息都会被消费</li></ul></li><li>消息确认（解决消息丢失问题）<ul><li>消费者获取消息后，消息处于 pending 状态，并存入一个 pending-list。当处理完成后需要通过 <code>XACK</code> 来确认消息，标记消息为已处理，才会从 pending-list 移除</li></ul></li></ol></li><li><p>相关命令</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 创建消费者组</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">XGROUP CREATE key groupname ID</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">$ </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">MKSTREAM</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">XGROUP create mystream group1 </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 删除指定消费者组</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">XGROUP DESTROY key groupname</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 给指定消费者组添加消费者</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">XGROUP CREATECONSUMER key groupname consumername</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 删除消费者组中指定消费者</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">XGROUP DELCONSUMER key groupname consumername</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>key</code>: 队列名称</li><li><code>groupName</code>: 消费者组名称</li><li><code>ID</code>: 起始 ID 标示，$ 代表队列中最后一个消息，0 则代表队列中第一个消息</li><li><code>MKSTREAM</code>: 队列不存在时自动创建队列（默认）</li></ul><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 从消费者组读取消息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">XREADGROUP GROUP group consumer </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">COUNT count</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">BLOCK milliseconds</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">NOACK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> STREAMS key </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">key </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> ID </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ID </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 例，读取未消费的消息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">XREADGROUP group group1 consumer1 count </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> block </span><span class="token number" style="color:#36acaa">2000</span><span class="token plain"> streams mystream </span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>group</code>: 消费组名称</li><li><code>consumer</code>: 消费者名称，如果消费者不存在，会自动创建一个消费者</li><li><code>count</code>: 本次查询的最大数量</li><li><code>BLOCK milliseconds</code>: 当没有消息时最长等待时间</li><li><code>NOACK</code>: 无需手动 ACK，获取到消息后自动确认</li><li><code>STREAMS key</code>: 指定队列名称</li><li><code>ID</code>: 获取消息的起始 ID:<ul><li><code>&gt;</code>: 从下一个未消费的消息开始</li><li>其它: 根据指定 id 从 pending-list 中获取已消费但未确认的消息，例如 0，是从 pending-list 中的第一个消息开始</li></ul></li></ul><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 确认消息已消费，并将消息从 pending-list 移除</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">XACK key group ID </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ID </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">XACK mystream group1 </span><span class="token number" style="color:#36acaa">1720096327447</span><span class="token plain">-0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 查看 pending-list 中的消息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">XPENDING key group </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">IDLE min-idle-time</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> start end count </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">consumer</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">XPENDING mystream group1 - + </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 读取 pending-list 中的消息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">XREADGROUP group group1 consumer1 count </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> block </span><span class="token number" style="color:#36acaa">2000</span><span class="token plain"> streams mystream </span><span class="token number" style="color:#36acaa">0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>STREAM类型消息队列的 <code>XREADGROUP</code> 命令特点</p><ul><li>消息可回溯</li><li>可以多消费者争抢消息，加快消费速度</li><li>可以阻塞读取</li><li>没有消息漏读的风险</li><li>有消息确认机制，保证消息至少被消费一次</li></ul></li><li><p>在 Java 中使用</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">testStream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">MapRecord</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> records </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> stringRedisTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">opsForStream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">Consumer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">from</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;group1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;consumer1&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">StreamReadOptions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">empty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">count</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">block</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Duration</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ofSeconds</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">StreamOffset</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;mystream&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">ReadOffset</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">lastConsumed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        records</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">forEach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">record </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">record</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-点赞功能">4. 点赞功能<a class="hash-link" href="#4-点赞功能" title="标题的直接链接">​</a></h2><ul><li>文章点赞功能：<ul><li>需要在数据库中存一个点赞数量的字段，点赞就加一，取消点赞就减一</li><li>使用 redis 的 set 结构维护 key 为文章 ID，value 存用户 ID 的数据<ul><li>使用 <code>ismember</code> 命令可用于判断用户是否点赞过文章，实现一个用户只能点赞一次</li></ul></li></ul></li><li>点赞列表根据点赞时间排序功能<ul><li>将 set 结构改成 sortedSet ，key 为文章 ID，score 为用户点赞的时间戳，value 为用户 ID<ul><li>使用 <code>zscore </code> 命令可用于判断用户是否点赞过文章， <code>zscore key vaule</code> 会返回 score，不存在会发挥 <code>nil</code></li><li>使用<code>zrange</code> 命令可以查询出点赞文章的所有用户 ID，然后再通过用户 ID 去数据库查询用户信息返回给前端</li></ul></li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-好友关注">5. 好友关注<a class="hash-link" href="#5-好友关注" title="标题的直接链接">​</a></h2><ul><li>设计一张关注表，包含主键、用户 ID、关注用户 ID<ul><li>用于存储好友关注信息</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="共同关注功能">共同关注功能<a class="hash-link" href="#共同关注功能" title="标题的直接链接">​</a></h3><ul><li>当前登录用户与查询的某个用户关注的共同好友，即求两个用户关注好友的交集<ul><li>可以使用 redis 的 set 结构存储关注的好友的信息，并使用 <code>sinter</code> 命令可以实现 set 集合求交集功能</li><li>每次关注好友时，同时将关注的好友的信息存储到 redis 中；取关时，同时移除 redis 的关注的好友的信息。key 为当前用户 ID，value 为关注的好友的 ID</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="关注推送">关注推送<a class="hash-link" href="#关注推送" title="标题的直接链接">​</a></h3><ul><li><p>关注推送也叫做 <strong>Feed 流</strong>，直译为投喂。为用户持续的提供“沉浸式”的体验，通过<strong>无限下拉刷新获取新的信息（类似抖音）</strong></p><ul><li>传统模式是用户找内容（搜索）</li><li>Feed 流模式是根据内容匹配对应的用户（推送）<ul><li>用户无需思考，直接投喂用户喜爱的内容</li></ul></li></ul></li><li><p><strong>Feed 流</strong>产品有两种常见模式</p><ol><li><strong>Timeline</strong>: 不做内容筛选，简单的按照内容发布时间排序，常用于好友或关注。例如：<strong>朋友圈、微博等</strong><ul><li>优点: 信息全面，不会有缺失。并且实现也相对简单</li><li>缺点: 信息噪音较多，用户不一定感兴趣，内容获取效率低</li></ul></li><li><strong>智能排序</strong>: 利用智能算法屏蔽掉违规的、用户不感兴趣的内容。推送用户感兴趣信息来吸引用户，例如：<strong>抖音</strong><ul><li>优点: 投喂用户感兴趣信息，用户粘度很高，容易沉迷</li><li>缺点: 如果算法不精准，可能起到反作用</li></ul></li></ol></li><li><p>在不同的平台，Feed 流可能有不同的名称和实现方式。</p><ul><li>例如：<ul><li>在抖音（TikTok）中，Feed 流通常指的是“推荐”页面上的内容，这些内容是根据用户的兴趣、观看历史和互动行为通过算法个性化推荐的。</li><li>在微博、Instagram、Facebook 等平台上，Feed 流则可能包括关注的好友、品牌或媒体账号发布的最新动态</li></ul></li><li>因此：关注推送功能的实现会选择 Feed 流的 <strong>Timeline</strong> 模式</li></ul></li><li><p>Feed 流实现方案有三种</p><ol><li><p>拉模式，也叫读扩散</p><ul><li>粉丝端拉取其关注的所有博主创作的内容，并按时间排序后粉丝端可依次读取出</li></ul></li><li><p>推模式，也叫写扩散</p><ul><li>博主端推送其创作的内容给所有关注该博主的粉丝，并按时间排序后粉丝端可依次读取出</li></ul></li><li><p>推拉结合，也叫做读写混合，兼具推和拉两种模式的优点</p><ul><li><p>对于小博主粉丝数量不多，可直接对所有粉丝使用推模式</p></li><li><p>对于大博主粉丝数量多，可对活跃粉丝（少数）使用推模式，对僵尸粉（多数）使用拉模式</p></li></ul></li></ol><table><thead><tr><th></th><th>拉模式</th><th>推模式</th><th>推拉结合</th></tr></thead><tbody><tr><td>写比例</td><td>低</td><td>高</td><td>中</td></tr><tr><td>读比例</td><td>高</td><td>低</td><td>中</td></tr><tr><td>用户读取延迟</td><td>高</td><td>低</td><td>低</td></tr><tr><td>实现难度</td><td>复杂</td><td>简单</td><td>很复杂</td></tr><tr><td>使用场景</td><td>很少使用</td><td>用户量少、没有大V</td><td>过千万的用户量，有大V</td></tr></tbody></table></li><li><p>可以基于 Redis 实现 feed 流推模式</p><ul><li><p>博主创作内容的同时将内容 ID 存储在 Redis 中，分页后再根据 ID 到数据库查询到内容返回给前端</p></li><li><p>Feed 流的分页问题</p><ul><li><p>Feed 流中的数据会不断更新，所以数据的角标也在变化，因此不能采用传统的分页模式</p><p><img loading="lazy" alt="image-20240712041701149" src="/assets/images/image-20240712041701149-31aada034e3b686b12ff376a97b3a8d6.png" width="986" height="421" class="img_ev3q"></p></li><li><p>Feed 流的滚动分页</p><p><img loading="lazy" alt="image-20240712042126710" src="/assets/images/image-20240712042126710-9647dc24ec1ab07c58960056bd5ed060.png" width="961" height="422" class="img_ev3q"></p></li></ul></li><li><p>考虑到上述问题，可以使用 Redis 的 sortedSet 结构存储投喂的内容（即博主创作的内容） ID</p><ul><li>原因：sortedSet 可以基于 score 实现滚动分页，使用 <code>zrevrangebyscore</code> 命令</li><li>key 为粉丝 ID，value 存博主创作的内容 ID，score 存时间戳</li><li>博主创作完内容的同时需要将内容 ID 推送给他的粉丝，即将内容 ID 存储到 Redis 中</li></ul></li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="6-附近的商家">6. 附近的商家<a class="hash-link" href="#6-附近的商家" title="标题的直接链接">​</a></h2><ul><li>可以使用 Redis 的 GEO 结构实现此功能<ul><li>按照商户类型做分组，类型相同的商户作为同一组，以 typeld（商户类型 id） 为 key ，将相同类型的商户坐标存入同一个 GEO 集合中即可</li><li><code>GEODIST</code> 命令可以求两个坐标的距离</li><li><code>GEOSEARCH</code>命令可以查询出某个范围的坐标</li><li>spring-data-reids 提供相关命令的 API: <code>stringRedisTemplate.opsForGeo()</code></li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="7-用户签到">7. 用户签到<a class="hash-link" href="#7-用户签到" title="标题的直接链接">​</a></h2><ul><li><p>用户签到这种类型的数据的数据量一般来说是非常大的，因此这种签到信息可以使用 BitMap（位图） 结构进行存储，可以大大减小缓存数据容量</p><ul><li>因此用户签到功能的基本思路：构造一个 31 位的 BitMap ，把每一个 bit 位对应当月的每一天，形成映射关系，用 0 和 1 标示签到状态</li><li>在 Redis 中，由于 BitMap 底层是基于 String 数据结构，因此其操作也都封装在字符串相关操作中了</li><li>存储在 Redis 中，key 可以为<code>用户ID+年月</code>，value 为 31 位的 BitMap</li></ul><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">testBitMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">LocalDateTime</span><span class="token plain"> now </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">LocalDateTime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">String</span><span class="token plain"> keySuffix </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> now</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ofPattern</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;:yyyyMM&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">String</span><span class="token plain"> userId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">String</span><span class="token plain"> key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;:sign:&quot;</span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> userId </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> keySuffix</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> day </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> now</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getDayOfMonth</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stringRedisTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">opsForValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setBit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> day</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;ok&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>统计最近连续签到天数</p><ul><li><p>从最后一次签到开始向前统计，直到遇到第一次未签到为止，计算总的签到次数，就是连续签到天数</p></li><li><p>使用 <code>bitfiled</code> 命令可以获取从第一天到最后一天的十进制数，对该十进制数进行位操作可以统计出连续签到数</p></li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="8-uv-统计">8. UV 统计<a class="hash-link" href="#8-uv-统计" title="标题的直接链接">​</a></h2><ul><li><p><code>UV</code>: 全称 Unique Visitor，也叫独立访客量，是指通过互联网访问、浏览这个网页的自然人。1天内同一个用户多次访问该网站，只记录 1 次</p></li><li><p><code>PV</code>: 全称 Page View，也叫页面访问量或点击量，用户每访问网站的一个页面，记录 1 次 PV，用户多次打开页面，则记录多次PV。往往用来衡量网站的流量</p></li><li><p>UV 统计在服务端做会比较麻烦，因为要判断该用户是否已经统计过了，需要将统计过的用户信息保存。但是如果每个访问的用户都保存到 Redis 中，数据量会非常恐怖</p></li><li><p>由于 HyperLogLog 内存占用极低，作为代价，其测量结果是概率性的，有小于0.81%的误差。不过对于 UV 统计来说，这完全可以忽略，且 HyperLogLog 不会存储重复元素，非常适合用来做 <code>UV</code> 统计</p><ul><li>实现思路：只需要将数据往 HyperLogLog  里面存放即可</li></ul><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">testHyperLogLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">String</span><span class="token plain"> key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;hll&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> values </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">10000</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> j </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            j </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            values</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">j</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;user_&quot;</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">j </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9999</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                stringRedisTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">opsForHyperLogLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> values</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;count: &quot;</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">stringRedisTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">opsForHyperLogLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Redis/RedisBasic"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">Redis 基础</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/category/dubbo"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">Dubbo</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-短信登录" class="table-of-contents__link toc-highlight">1. 短信登录</a><ul><li><a href="#session-共享问题" class="table-of-contents__link toc-highlight">session 共享问题</a></li><li><a href="#登录拦截器优化" class="table-of-contents__link toc-highlight">登录拦截器优化</a></li></ul></li><li><a href="#2-查询缓存" class="table-of-contents__link toc-highlight">2. 查询缓存</a><ul><li><a href="#缓存更新策略" class="table-of-contents__link toc-highlight">缓存更新策略</a></li><li><a href="#缓存穿透" class="table-of-contents__link toc-highlight">缓存穿透</a></li><li><a href="#缓存雪崩" class="table-of-contents__link toc-highlight">缓存雪崩</a></li><li><a href="#缓存击穿" class="table-of-contents__link toc-highlight">缓存击穿</a></li></ul></li><li><a href="#3-优惠券秒杀" class="table-of-contents__link toc-highlight">3. 优惠券秒杀</a><ul><li><a href="#全局唯一-id" class="table-of-contents__link toc-highlight">全局唯一 ID</a></li><li><a href="#超卖问题" class="table-of-contents__link toc-highlight">超卖问题</a></li><li><a href="#一人一单" class="table-of-contents__link toc-highlight">一人一单</a></li><li><a href="#分布式锁" class="table-of-contents__link toc-highlight">分布式锁</a></li><li><a href="#秒杀业务优化" class="table-of-contents__link toc-highlight">秒杀业务优化</a></li><li><a href="#redis-实现消息队列" class="table-of-contents__link toc-highlight">Redis 实现消息队列</a></li></ul></li><li><a href="#4-点赞功能" class="table-of-contents__link toc-highlight">4. 点赞功能</a></li><li><a href="#5-好友关注" class="table-of-contents__link toc-highlight">5. 好友关注</a><ul><li><a href="#共同关注功能" class="table-of-contents__link toc-highlight">共同关注功能</a></li><li><a href="#关注推送" class="table-of-contents__link toc-highlight">关注推送</a></li></ul></li><li><a href="#6-附近的商家" class="table-of-contents__link toc-highlight">6. 附近的商家</a></li><li><a href="#7-用户签到" class="table-of-contents__link toc-highlight">7. 用户签到</a></li><li><a href="#8-uv-统计" class="table-of-contents__link toc-highlight">8. UV 统计</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 HankLay, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.6d6f6b8c.js"></script>
<script src="/assets/js/main.31e09b09.js"></script>
</body>
</html>