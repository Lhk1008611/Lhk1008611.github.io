<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Redis/RedisSenior">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">Redis 高级 | HankLay 的个人主页</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://lhk1008611.github.io/docs/Redis/RedisSenior"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Redis 高级 | HankLay 的个人主页"><meta data-rh="true" name="description" content="一、分布式缓存"><meta data-rh="true" property="og:description" content="一、分布式缓存"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://lhk1008611.github.io/docs/Redis/RedisSenior"><link data-rh="true" rel="alternate" href="https://lhk1008611.github.io/docs/Redis/RedisSenior" hreflang="zh"><link data-rh="true" rel="alternate" href="https://lhk1008611.github.io/docs/Redis/RedisSenior" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.db39acd3.css">
<link rel="preload" href="/assets/js/runtime~main.5b267564.js" as="script">
<link rel="preload" href="/assets/js/main.2c7bbae3.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/favicon.ico" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/favicon.ico" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">首页</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">文档</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/Lhk1008611" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">个人简历</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/java">Java</a><button aria-label="打开/收起侧边栏菜单「Java」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/mq">MQ</a><button aria-label="打开/收起侧边栏菜单「MQ」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/mysql">MySQL</a><button aria-label="打开/收起侧边栏菜单「MySQL」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/linux">Linux</a><button aria-label="打开/收起侧边栏菜单「Linux」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/ssm">SSM</a><button aria-label="打开/收起侧边栏菜单「SSM」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/redis">Redis</a><button aria-label="打开/收起侧边栏菜单「Redis」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Redis/RedisInstall">Redis 的安装及启动</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Redis/RedisBasic">Redis 基础</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Redis/RedisBusinessScenarios">基于 Redis 的业务场景</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Redis/RedisSenior">Redis 高级</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Redis/ReidsPrinciple">Redis 原理</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/dubbo">Dubbo</a><button aria-label="打开/收起侧边栏菜单「Dubbo」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/docker">Docker</a><button aria-label="打开/收起侧边栏菜单「Docker」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/spring-cloud">Spring Cloud</a><button aria-label="打开/收起侧边栏菜单「Spring Cloud」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/cloud-native">Cloud Native</a><button aria-label="打开/收起侧边栏菜单「Cloud Native」" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/redis"><span itemprop="name">Redis</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Redis 高级</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>Redis 高级</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一分布式缓存">一、分布式缓存<a class="hash-link" href="#一分布式缓存" title="标题的直接链接">​</a></h2><ul><li>单节点问题<ol><li>数据丢失问题<ul><li>Redis是内存存储，服务重虑可能会丢失数据</li></ul></li><li>并发能力问题<ul><li>单节点 Redis 并发能力虽然不错，但也无法满足如 618 这样的高并发场景</li></ul></li><li>故障恢复问题<ul><li>如果 Redis 宕机，则服务不可用，需要一种自动的故障恢复手段</li></ul></li><li>存储能力问题<ul><li>Redis 基于内存，单节点能存储的数据量难以满足海量数据需求</li></ul></li></ol></li><li>上述问题可以通过 Redis 集群进行解决<ul><li>对于问题1：实现 Redis 数据持久化</li><li>对于问题2：搭建主从集群，实现读写分离</li><li>对于问题3：利用 Redis 哨兵，实现健康检测和自动恢复</li><li>对于问题4：搭建分片集群，利用插槽机制实现动态扩容</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-redis-持久化">1. Redis 持久化<a class="hash-link" href="#1-redis-持久化" title="标题的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="rdb-持久化">RDB 持久化<a class="hash-link" href="#rdb-持久化" title="标题的直接链接">​</a></h4><ul><li><p>RDB 全称 Redis Database Backup file( Redis 数据备份文件)，也被叫做 Redis 数据快照。简单来说就是把内存中的所有数据都记录到磁盘中。当 Redis 实例故障重启后，从<strong>磁盘</strong>读取快照文件，恢复数据</p></li><li><p>快照文件称为 RDB 文件，默认是保存在当前运行目录</p><ul><li>通过 <code>save</code> 命令开启 RDB 持久化，且由 Redis 主进程来执行 RDB，会阻塞所有命令</li><li>通过<code>bgsave</code>命令开启子进程执行 RDB，避免主进程受到影响，属于异步持久化</li></ul></li><li><p>Redis 默认开启 RDB：Redis 停机时会执行一次 RDB</p><ul><li><p>可以在 redis.conf 文件中配置触发 RDB 的机制</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 900 秒内，如果至少有 1 个 key 被修改，则执行 bgsave，如果配置为 save &quot;&quot; 则表示禁用 RDB</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">save </span><span class="token number" style="color:#36acaa">900</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="image-20240715054703022" src="/assets/images/image-20240715054703022-391e859ada411fc2884aeb9459ba9704.png" width="1422" height="599" class="img_ev3q"></p></li><li><p>其他相关配置，具体查看 redis.conf 文件</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 是否压缩 ,建议不开启，压缩也会消耗 cpu，磁盘的话不值钱</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rdbcompression </span><span class="token function" style="color:#d73a49">yes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># RDB文件名称</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dbfilename dump.rdb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#文件保存的路径目录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">dir</span><span class="token plain"> ./</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="image-20240715055003315" src="/assets/images/image-20240715055003315-c214809804555a36ccaf89b0012129a4.png" width="1422" height="161" class="img_ev3q"></p><p><img loading="lazy" alt="image-20240715055116484" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABY4AAABFCAYAAADthXI9AAAOfElEQVR4nO3dvWrjaBvG8Wv2Ay0z7DFsoyUEQRp17hcEKZQuXUCdOzeDyhQpxdu4cydI584qAt4TcKfGYExA7AksewBqdt9Cli3Z8odsybFn/j8ITDzSo1vS4xSXH9/6lKbpfwIAAAAAAAAAfPP++ecf/fnnn/r777/1xx9/6Pfff9fPP/+8sd0PH1AbAAAAAAAAAOADGIahH3/8UZL0yy+/LP+9juAYAAAAAAAAAL4TX7580ZcvX/Trr7/q8+fP+uGH6oj4E60qAAAAAAAAAOD78ddffylNU/3222/6/Plz5TYExwAAAAAAAADwHfn3338laetqY0n66VzFAAAAAAAAAAA+3q7AeLnNGeoAAAAAAAAAAFwRgmMAAAAAAAAAQAnBMQAAAAAAAACghOAYAAAAAAAAAFBCcAwAAAAAAAAAKCE4BgAAAAAAAACUEBwDAAAAAAAAAEoIjgEAAAAAAAAAJQTHAAAAAAAAAIASgmMAAAAAAAAAQEnrwfG4a6jTT/JfZBhdjXfukajfMWQYe346fSWSkn5HhmGou3vQxoy7qxo6/WR5/OU5ZhudtaZv1bnv7dX6Dubb2eZC0ldn29+cXQdf3INtf6cAAAAAAACuTcvB8VijULq7MSVJyftUsm9l7tzHVG+SKk3zn5kCW5I8RWnh9UlvzzjNG3cNuaGtYJbVMOmduwJcsuxDhX0fjGCXS7mGdjAr/A3KfiK5mx8S7dwvkhf7si7gfAAAAAAAAOpqNzhO3jWVrdtFvprMY+nu5uyBbzMSvU8l2Y+6L5yA2ZsQIkPL+YETXPY1dAap0lkg+dbu1cerPTSIPEmhRiTHAAAAAADgyrQcHM8V607ZguMsFLJvCVgBXCmzp9fAlkL3m24NAgAAAAAA0EJwXOhR7IaSQrmGIcOw5MdS7Ft7v+59rGL/4V39UNe321dL1l81q1+xL8swZBgd9RPV7i+779jFXq4HnU9Fb9X17Q4Zs61rl22/uFarihZzZP31sbpbesk2Vt/yfhXm6Vof2pPmx3K+b+63Pu4xLRkOra36umvZw7e4XyPzY3FdO/2kYk7uP89Dr+FBtdS8VnWZvWd5ksIDlhEn2dcUxOdlAAAAAADg2rQQHK96FEdeoefnLJBd6FPcdGuH0DX0cjsr9UUO3fVQKQsm3WmgWd6HNPKyMHtH8pu1o1j0WrbzfSeqdwr1jh26hkYP6dr5rAWBSV+d0UO5D6tXsV3lmFEWfrlZqLZ57apD3brXznnwJMUavhUGS940jCUp1rx0Pu+aanNVehv3dvrypOHjbK1fdgPzo3KOL8YNi326ZwrsUG5VuFspC7qLPbbTNNXz3FLnpZn+DqfNj0zsWzJeblfXL43kaf957r+Gqxrbep8fztStLSkc7Q7Ex11Zfiw7eK35twIAAAAAAODjtdiqImtNkT8YT8lc8d4H453Aiwohk6nea6As21lFO+Ouq1CeouKD9ZyBsjakLwcGeMepfWwv0sDJf8nPJ5b/v0JUZfY0WW2UDfm1YrvKMR19zVI6yQ70unHtymHv0dfOeZAnKS4mxMlcsWzZdvn+JG9DxbL1eL82S1q4t7EeC+d84jnukY1rK5gNtLpbpnqTSJ5i+U/lFc9Vkv6T/FjyovIHFs4g1fNdfFxh606YH0t2oFnpwZWOBrMdc/KIGj/+fW7q5q76f/JvVCy/cVGqFwAAAAAA4Hq0GhzP49VXtMejsNUH43kP5QBV5o3uJGn6vgjlxhqFkrwHrW0p89bWxurXRtU/9tbz2SXpq2P52hYjro9pLtIv+/G+8r6swt5Trp2jh+x7/cvVmeNRKNmPen60S68n83jj4YNVdTdxbzfPua35kY/7XLHqdHFt4qGqMtiVRG/DWLIDfV0vTvmq7tMdPz9WKrc17/Voq3C/mqvxst7nhW9Y5Cuip26tVjYAAAAAAACX4qemB0z6HVl+Ibq0DPnLX1wZoZR9FX2wEey0atEGQWFew5Uee/quRE6htYKrxk9nEcYt7+KJ9WeBXajReCDHyYI9O7iXczOXNNV7Ijnm6vXaHy4cUd9yJfwJY9SpbdtDIbNrs3cQzWNJXnsfvNSyPj8KNq5rtkO2QjecK5HaPYezvM+zb1No7zcoslXlc8NV+NLXV6d3GfcPAAAAAADgAI2vOM56laaaBXahH3DWL9WL8pV4Zw6Ni7yo1BO4+DNou6hGj52o38lD42Lf2+xat+LI+s37R2ULTpNFsLdoR+E8yMtbHiwCv+rgsd36Gh8DaxZB6zm1eR/zHt0HfYMiX1U+P3m1NQAAAAAAwDm11qoimcerYCV511Se1r9lflYbX2m/8mPn4ZUXHfGgvppOrX/RqiAevmn8NlS8bEeRhWrL14+dI01c37bmR746d0t/hGQeS7rTQXn5ltqSs6ey203fKyvMVky32eM8d4b3ed6LO6jqGwIAAAAAAPCNaCk4zlYYLvuRtv1gvIMc2k/2yo89HjXfuuLk+k3dP9pSPNeo+IGCFq0a8tcr+tKep76mxtgxbuVD2bb34z28tkX/4zXb+vlmoWd74uHbZmC7mJPbeiU3q+X32rgry49lB68HflizuMcf/vcPAAAAAACgntaC4+KD8ZL3aasPxjuU8zWQrVi+1VXpWVXjroyWn17V+LHzB44VHi6npK+O205j11Przx60FioMyw84y9pYZK9v6wN8jvpOH2MRjivUaG1TZxDJ2xg3bzXiKTqgd8L2MSwNtdknOW8PEr70V0Fu0teT32ZsLCn2ZRWvVT4n7UCve5PW7dewjnbe54n6HUOGG8qLUk0OSo3ze2wreKW/MQAAAAAAuC4tBceOBoX2CWZvovQSGsSaPU3SSJ5CuYYhI/8ZPbRfX+PHzh68VRrPmuu5rR7Hp9bvPCzqWmtHkQfged/jj6qvgTHM3qsCWwrdbL/Ocomxo0E6U2AXx7XkK9Ds4H7fjgYbtVmaP6eaPN9Vn8sskB37svLtn6TXWVARMzfHDmaK5K6uneUr9iKlk8OC0+3XsIYG5kLsW6v98vt1F+3tkVzeL7/HLbeSAQAAAAAAaMGnNE3/++giAFy5cVeGG8oOZgeuxgUAAAAAAMAla+3heAAAAAAAAACA60RwDAAAAAAAAAAoITgGAAAAAAAAAJTQ4xgAAAAAAAAAUMKKYwAAAAAAAABACcExAAAAAAAAAKCE4BgAAAAAAAAAUEJwDAAAAAAAAAAoITgGAAAAAAAAAJScPzged2UYhrrjzdc6/aTmUIYMw1jum/Q7m+NUHQ/Vvvdr1eDcBAAAAAAAAK7Z1a44HncNuaGtYJYqTVNNeuZHlwQAAAAAAAAA34SfPrqA4yR6n0qyH3VfyIvN3kRp78OKAgAAAAAAAIBvwtWuOAYAAAAAAAAAtKPV4LjYg/jgPrGLnrKrn66KLWezPsaW/FhS7MsyDBlGR/1EtXv07qsv75ncHW9uW3mMjdo3tztkzIOOdUD9p5x7ebvF9S2fiDpr+zVybsWewnvmwo6TW4ydqN9Z7NvpKylt0vzcBAAAAAAAAL4VLQXHWWBX7EGcpqme55Y6L9Ote8W+JePlVrM03yeSp1BuIbg0exOl6UyBLckOFttOVK/F8Vhdw5A7DVbHirzs+BUpbegaGj3kNWXHDt21MDXpqzN6WJ5rmqaKvIrtKseM5C1eMwxDL7ez3ceqWX/ZcfemjtPOLXPIXNhn+vKk4ePieJOezBPOv4l6AAAAAAAAgGvRSnCc9J/kx5IXlQNdZ5Dq+S7evqMdaLYM+CTJ0WAWyFYs/3/Nre0cd12F8hQVj+UMFHmSwpfNINCLNHDyX0z1XitqMnuarDbKhvy6o/bSmI6+Bnb2TzvQ6/KirY41fFsVVbv+gqPvTR0nnNtSA3Mh1mPheJlLn5sAAAAAAADAJWghOE70NowlO9BXZ/N/nQdv65724702Fg6b93q0JYWjhtoCjDUKJXkPWi/PvLUlxZqv5Zjew9qW5o3u9h0m6atj+doWRa6Pad5kI1ZeA0nxsqj69ReKOvre1HH8ua3snAvTdx2yyHdzjEufmwAAAAAAAMBlaCU4nseS7m4qQ8Jd7m6q9jB1szelrSF511SSQnejH7Hl11xxWwows/YRy/F2hMa1rIfUJ9V//L1pxY4AfudciOcHBcebY1z43AQAAAAAAAAuRKsPx2tGovdmWu+WeVGpH3HxZ1CxGnVfjf2Oq1CSVOydm/X3bUWj9V+LlubC0S6tHgAAAAAAAKAZ7QXHW9oJJDuStul75R7ZKlH7tplVsvkq1wPbHRwkedMw1iLMrfugvpqaqP+Ie3Nurc6FS52bAAAAAAAAwIVoITh29OBJiofafObZosfsFvHwbTPQG48Uant/3Gbra9ii9madUn/9e7Otb3LyNmymFccW7cyFS5+bAAAAAAAAwGVoZcWxM4jkKZZvdQsPDUvU71gayt6+Y+zL6hYeM5b01XFDyQ702uAyXudrIHujPknjrozuEY85q3pIWl57C06pv+69Me8fZUsKX/qr4DTp66luP+i6DpoLifodQ4bRUf/AEP3S5yYAAAAAAABwCX5qZ1hHgzSSDFeusQpPvSjVRF0ZbnXoaAczPc8tGUbhRS9S2nTTXrOnSXqj7lp9xx/LVG8SaV4az1OURhoZbvOrjk+qv+a9MXuazKSO5csy/Ow1O9BsFujJ8ps5nwrtzYULn5sAAAAAAADABfiUpul/H10EsDTuynBD2cFME1byAgAAAAAAAB+ivYfjAQAAAAAAAACuEsExAAAAAAAAAKCE4BgAAAAAAAAAUEKPYwAAAAAAAABACSuOAQAAAAAAAAAlBMcAAAAAAAAAgBKCYwAAAAAAAABACcExAAAAAAAAAKCE4BgAAAAAAAAAUEJwDAAAAAAAAAAoITgGAAAAAAAAAJQQHAMAAAAAAAAASgiOAQAAAAAAAAAlBMcAAAAAAAAAgJL/A7wR+7FFvAMTAAAAAElFTkSuQmCC" width="1422" height="69" class="img_ev3q"></p><p><img loading="lazy" alt="image-20240715055215350" src="/assets/images/image-20240715055215350-294ee219cbb752ec65c2cb201d129c9a.png" width="1422" height="237" class="img_ev3q"></p></li></ul></li></ul><h5 class="anchor anchorWithStickyNavbar_LWe7" id="bgsave-的流程">bgsave 的流程<a class="hash-link" href="#bgsave-的流程" title="标题的直接链接">​</a></h5><ul><li><p>bgsave 开始时会先 fork 主进程得到子进程，子进程共享主进程的内存数据。完成 fork 后读取内存数据并写入新的 RDB 文件，用新 RDB 文件替换旧的 RDB 文件</p></li><li><p>fork 的原理</p><ul><li>在 Linux 系统中，进程不能直接操作物理内存，而是通过维护一张页表实现对物理内存中数据的映射，相当于通过页表可以间接操作物理内存</li><li>在 fork 时，是将主进程的页表拷贝到子进程，保证子进程也可以操作主进程的数据，实现内存数据的共享</li><li>且 fork 采用 copy-on-write 技术<ul><li>当主进程执行读操作时，访问共享内存，当主进程执行写操作时，则会拷贝一份数据，执行写操作</li></ul></li></ul><p><img loading="lazy" alt="image-20240715060654524" src="/assets/images/image-20240715060654524-ca25242e371e21ec2afe82ed2a72dcca.png" width="1287" height="462" class="img_ev3q"></p></li><li><p>RDB 的 缺点</p><ol><li>两次 RDB 执行间隔时间长，导致两次 RDB 之间写入数据有丢失的风险</li><li>fork 子进程、压缩、写出 RDB 文件都比较耗时</li></ol></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="aof-持久化">AOF 持久化<a class="hash-link" href="#aof-持久化" title="标题的直接链接">​</a></h4><ul><li><p>AOF 全称为 Append OnlyFile (追加文件)。将 Redis 处理的每一个<strong>写命令</strong>都会记录在AOF文件，可以看做是命令日志文件</p></li><li><p>AOF 默认是关闭的，需要修改 redis.conf 配置文件来开启 AOF</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#是否开启AOF功能，默认是no</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">appendonly </span><span class="token function" style="color:#d73a49">yes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#AOF文件的名称 </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">appendfilename:&quot;appendonly.aof</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="image-20240715061918592" src="/assets/images/image-20240715061918592-117d7a4c16fdf33c7d9631c9e8665205.png" width="1422" height="546" class="img_ev3q"></p><p><img loading="lazy" alt="image-20240715062011162" src="/assets/images/image-20240715062011162-50b0a5f3d289dc3e2eabdfefbb19bf19.png" width="1422" height="634" class="img_ev3q"></p></li><li><p>刷盘策略：AOF 的<strong>命令记录的频率</strong>也可以通过 redis.conf 文件进行配置</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#表示每执行一次写命令，立即记录到 A0F 文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">appendfsync always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#写命令执行完先放入 AOF 缓冲区，然后表示每隔 1 秒将缓冲区数据写到 A0F 文件，是默认方案</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">appendfsync everysec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#写命令执行完先放入 AOF 缓冲区，由操作系统决定何时将缓冲区内容写回磁盘</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">appendfsync no</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="image-20240715062251901" src="/assets/images/image-20240715062251901-7a3935d06fe1c411588f0079583101aa.png" width="1422" height="649" class="img_ev3q"></p><table><thead><tr><th>配置项</th><th>刷盘时机</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>Always</td><td>同步刷盘</td><td>可靠性高，几乎不丢数据</td><td>性能影响大</td></tr><tr><td>everysec</td><td>每秒刷盘</td><td>性能适中</td><td>最多丢失 1 秒数据</td></tr><tr><td>no</td><td>操作系统控制</td><td>性能最好</td><td>可靠性较差，可能丢失大量数据</td></tr></tbody></table></li><li><p>因为是记录命令，AOF 文件会比 RDB 文件大的多。而且 AOF 会记录对同一个 key 的多次写操作，但只有最后一次写操作才有意义</p><ul><li><p>可以通过执行 <code>bgrewriteaof</code> 命令，可以让 A0F 文件执行<strong>重写</strong>功能，用最少的命令达到相同效果</p><p><img loading="lazy" alt="image-20240715063431699" src="/assets/images/image-20240715063431699-b77ff4d636f93f728d82462874448f09.png" width="1206" height="161" class="img_ev3q"></p></li><li><p>也可以在 redis.conf 中配置自动去重写 AOF 文件</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># AOF文件比上次文件增长超过多少百分比则触发重写</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">auto-aof-rewrite-percentage </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># AOF文件体积最小多大以上才触发重写</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">auto-aof-rewrite-min-size 64mb</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="image-20240715063810279" src="/assets/images/image-20240715063810279-d0a661b12a8b25ae7a32c3d0a26bb530.png" width="1422" height="475" class="img_ev3q"></p></li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="rdb-与-aof-的区别">RDB 与 AOF 的区别<a class="hash-link" href="#rdb-与-aof-的区别" title="标题的直接链接">​</a></h4><ul><li><p>RDB 和 AOF 各有自己的优缺点，如果对数据安全性要求较高，在实际开发中往往会结合两者来使用</p><table><thead><tr><th></th><th>RDB</th><th>AOF</th></tr></thead><tbody><tr><td>持久化方式</td><td>定时对整个内存做快照</td><td>记录每一次执行的命令</td></tr><tr><td>数据完整性</td><td>不完整，两次备份之间会丢失</td><td>相对完整，取决于刷盘策略</td></tr><tr><td>文件大小</td><td>会有压缩，文件体积小</td><td>记录命令，文件体积很大</td></tr><tr><td>宕机恢复速度</td><td>很快</td><td>慢</td></tr><tr><td>数据恢复优先级</td><td>低，因为数据完整性不如AOF</td><td>高，因为数据完整性更高</td></tr><tr><td>系统资源占用</td><td>高，大量CPU和内存消耗</td><td>低，主要是磁盘 I0 资源但 AOF 重写时会占用大量 CPU 和内存资源</td></tr><tr><td>使用场景</td><td>可以容忍数分钟的数据丢失，追求更快的启动速度</td><td>对数据安全性要求较高常见</td></tr></tbody></table></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-redis-主从">2. Redis 主从<a class="hash-link" href="#2-redis-主从" title="标题的直接链接">​</a></h3><ul><li><p>单节点 Redis 的并发能力是有上限的，要进一步提高 Redis 的并发能力，就需要搭建主从集群，实现读写分离</p><p><img loading="lazy" alt="image-20240715231608313" src="/assets/images/image-20240715231608313-30d4b8c090586db9e253a0fcac518734.png" width="1235" height="577" class="img_ev3q"></p></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-集群搭建">1. 集群搭建<a class="hash-link" href="#1-集群搭建" title="标题的直接链接">​</a></h4><ul><li><p>要在同一台虚拟机开启3个实例，必须准备三份不同的配置文件和目录，配置文件所在目录也就是工作目录</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 1.创建目录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> redis1 redis2 redis3 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 2.拷贝 redis.conf</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> redis1 redis2 reids3 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">xargs</span><span class="token plain"> -t -n </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> redis-6.2.14/redis.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 3. 修改每个实例的端口、工作目录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> -i -e </span><span class="token string" style="color:#e3116c">&#x27;s/6379/7001/g&#x27;</span><span class="token plain"> -e </span><span class="token string" style="color:#e3116c">&#x27;s/dir .\//dir \/opt\/redis1\//g&#x27;</span><span class="token plain"> redis1/redis.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> -i -e </span><span class="token string" style="color:#e3116c">&#x27;s/6379/7002/g&#x27;</span><span class="token plain"> -e </span><span class="token string" style="color:#e3116c">&#x27;s/dir .\//dir \/opt\/redis2\//g&#x27;</span><span class="token plain"> redis2/redis.conf </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> -i -e </span><span class="token string" style="color:#e3116c">&#x27;s/6379/7003/g&#x27;</span><span class="token plain"> -e </span><span class="token string" style="color:#e3116c">&#x27;s/dir .\//dir \/opt\/redis3\//g&#x27;</span><span class="token plain"> redis3/redis.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 4. 修改每个实例的声明 IP，在 redis.conf 文件中指定每一个实例的绑定 ip 信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> -i </span><span class="token string" style="color:#e3116c">&#x27;1a replica-announce-ip 192.168.136.131&#x27;</span><span class="token plain"> redis1/redis.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> -i </span><span class="token string" style="color:#e3116c">&#x27;1a replica-announce-ip 192.168.136.131&#x27;</span><span class="token plain"> redis2/redis.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> -i </span><span class="token string" style="color:#e3116c">&#x27;1a replica-announce-ip 192.168.136.131&#x27;</span><span class="token plain"> redis3/redis.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 5. 若主节点有密码，在每个从节点中配置主节点的密码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> -i </span><span class="token string" style="color:#e3116c">&#x27;1a masterauth 222333&#x27;</span><span class="token plain"> redis2/redis.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> -i </span><span class="token string" style="color:#e3116c">&#x27;1a masterauth 222333&#x27;</span><span class="token plain"> redis3/redis.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-启动">2. 启动<a class="hash-link" href="#2-启动" title="标题的直接链接">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">redis-server redis1/redis.conf </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redis-server redis2/redis.conf </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redis-server redis3/redis.conf </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-开启主从关系">3. 开启主从关系<a class="hash-link" href="#3-开启主从关系" title="标题的直接链接">​</a></h4><ul><li><p>配置节点的主从可以使用 <code>replicaof</code> 或者 <code>slaveof</code>(5.0以前)命令</p></li><li><p>有临时和永久两种模式:</p><ol><li><p>修改配置文件(永久生效)</p><ul><li>在 redis.conf 中添加一行配置: <code>slaveof &lt;masterip&gt;&lt;masterport&gt;</code></li></ul></li><li><p>使用 redis-cli 客户端连接到 redis 服务，执行 <code>slaveof</code> 命令(重启后失效) <code>slaveof &lt;masterip&gt;&lt;masterport&gt;</code></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 1. 启动各节点 redis 服务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redis-server redis1/redis.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redis-server redis2/redis.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redis-server redis3/redis.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 2. 配置节点主从关系，以 7001 端口的 redis 节点为主节点</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redis-cli -p </span><span class="token number" style="color:#36acaa">7002</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SLAVEOF </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.136.131 </span><span class="token number" style="color:#36acaa">7001</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 查看节点信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO replication</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redis-cli -p </span><span class="token number" style="color:#36acaa">7003</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SLAVEOF </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.136.131 </span><span class="token number" style="color:#36acaa">7001</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 查看节点信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO replication</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-主从数据同步原理主从复制">4. 主从数据同步原理（主从复制）<a class="hash-link" href="#4-主从数据同步原理主从复制" title="标题的直接链接">​</a></h4><ul><li><p>主从集群搭建好后，可以在主节点进行写操作，从节点会同步主节点的数据</p></li><li><p>主从第一次同步是全量同步</p><ul><li>Replication ld: 简称 replid，是数据集的标记，id一致则说明是同一数据集。每一个 master 都有唯一的 replid，slave 则会继承master 节点的 replid</li><li>offset: 偏移量，随着记录在 repl_baklog 中的数据增多而逐渐增大。slave 完成同步时也会记录当前同步的 offset.
如果 slave 的 offset 小于 master 的offset，说明 slave 数据落后于 master，需要更新。</li></ul><p><img loading="lazy" alt="image-20240716005749680" src="/assets/images/image-20240716005749680-5c4305c7f6c611f4de1368827463b1fa.png" width="1176" height="641" class="img_ev3q"></p><ul><li><strong>全量同步的流程</strong><ul><li>slave 节点请求增量同步</li><li>master 节点判断 replid，发现不一致（说明是第一次），拒绝增量同步，开始全量同步</li><li>master 将完整内存数据生成 RDB，发送 RDB 到 slave</li><li>slave 清空本地数据，加载 master 的 RDB</li><li>master 将 RDB 期间的命令记录在 repl_baklog，并持续将 repl_baklog中的命令发送给 slave</li><li>slave 执行接收到的命令，保持与 master 之间的同步</li></ul></li></ul></li><li><p>如果 slave 重启后同步，则执行<strong>增量同步</strong></p><p><img loading="lazy" alt="image-20240716010924975" src="/assets/images/image-20240716010924975-39fb932e4330142bd205ae8b7bed9700.png" width="1202" height="504" class="img_ev3q"></p><ul><li>repl_baklog 大小有上限，写满后会覆盖最早的数据。如果 slave 断开时间过久，导致<strong>数据被覆盖</strong>，则无法实现增量同步，<strong>只能再次全量同步</strong></li></ul></li><li><p>全量同步和增量同步区别</p><ul><li><strong>全量同步</strong>: master 将完整内存数据生成 RDB，发送 RDB 到 slave。后续命令则记录在 repl_baklog，逐个发送给slave</li></ul></li></ul><ol><li><p>slave 节点第一次连接 master 节点时会执行全量同步</p></li><li><p>slave 节点断开时间太久，repl_baklog 中的 offset 已经被覆盖时也会执行全量同步</p></li></ol><ul><li><strong>增量同步</strong>: slave提交自己的 offset 到 master，master 获取 repl_baklog 中从 offset 之后的命令给 slave<ul><li>slave 节点断开又恢复，并且在 repl_baklog 中能找到 offset 时执行增量同步</li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="5-主从集群优化">5. 主从集群优化<a class="hash-link" href="#5-主从集群优化" title="标题的直接链接">​</a></h4><ul><li><p>在 master 中配置 <code>repl-diskless-syncyes</code> 启用无磁盘复制，避免全量同步时的磁盘 I0</p></li><li><p>Redis 单节点上的内存占用不要太大，减少 RDB 导致的过多磁盘 I0</p></li><li><p>适当提高 repl_baklog 的大小，发现 slave 宕机时尽快实现故障恢复，尽可能避免全量同步</p></li><li><p>限制一个 master 上的 slave 节点数量，如果实在是太多 slave，则可以采用<code>主-从-从</code>链式结构，减少 master 压力</p><p><img loading="lazy" alt="image-20240716011627204" src="/assets/images/image-20240716011627204-ef5bee0db8644fbe20ea3a73616d0875.png" width="1360" height="407" class="img_ev3q"></p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-redis-哨兵">3. Redis 哨兵<a class="hash-link" href="#3-redis-哨兵" title="标题的直接链接">​</a></h3><ul><li>slave 节点宕机恢复后可以找 master 节点同步数据，那 master 节点宕机怎么办?<ul><li>Redis 提供了哨兵( Sentinel ) 机制来实现主从集群的自动故障恢复</li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-哨兵的作用和原理">1. 哨兵的作用和原理<a class="hash-link" href="#1-哨兵的作用和原理" title="标题的直接链接">​</a></h4><ul><li><p>作用</p><ul><li><strong>监控</strong>: Sentinel 会不断检查您的 master 和 slave 是否按预期工作</li><li><strong>自动故障恢复</strong>: 如果 master 故障，Sentinel 会将一个 slave 提升为 master。当故障实例恢复后也以新的 master 为主</li><li><strong>通知</strong>: Sentinel 充当 Redis 客户端的<strong>服务发现</strong>来源，当集群发生故障转移时，会将最新信息推送给 Redis 的客户端</li></ul><p><img loading="lazy" alt="image-20240716022801022" src="/assets/images/image-20240716022801022-75b518ec30f59779555ff5955e147807.png" width="687" height="554" class="img_ev3q"></p></li><li><p>服务状态监控</p><ul><li>Sentinel 基于<strong>心跳机制</strong>监测服务状态，每隔 1 秒向集群的每个实例发送 <code>ping</code> 命令:<ul><li>主观下线: 如果某 sentinel 节点发现某实例未在规定时间响应，则认为该实例主观下线。(有可能是因为网络问题响应超时)</li><li>客观下线: 若超过指定数量(quorum)的 sentinel 都认为该实例主观下线，则该实例客观下线。<ul><li>quorum 值最好超过 Sentinel 实例数量的一半</li></ul></li></ul></li></ul><p><img loading="lazy" alt="image-20240716032515528" src="/assets/images/image-20240716032515528-4247b4454ee799e7a0de1922a2f5a8d7.png" width="761" height="442" class="img_ev3q"></p></li><li><p>选举新的 master</p><ul><li>一旦发现 master 故障，sentinel 需要在 salve 中选择一个作为新的 master</li><li>选举规则<ul><li>首先会判断 slave 节点与 master 节点<strong>断开时间长短</strong>，如果超过指定值(<code>down-after-miliseconds*10</code>)则会排除该
slave 节点</li><li>然后判断 slave 节点的优先级 <code>slave-priority</code> 值，越小优先级越高，如果是 0 则永不参与选举</li><li>如果 <code>slave-prority</code> 一样，则判断 slave 节点的 offset 值，越大说明数据越新，优先级越高</li><li>最后是判断 slave 节点的运行 id 大小，越小优先级越高</li></ul></li></ul></li><li><p>故障转移</p><ul><li>当选中了其中一个 slave 为新的 master 后<ol><li>sentinel 给备选的 slave 节点发送 <code>slaveof no one</code>命令，让该节点成为新的 master</li><li>sentinel 给所有其它 slave 发送 <code>slaveof ip port</code>命令，让这些 slave 成为新 master 的从节点，开始从新的 mastel 上同步数据</li><li>最后，sentinel 将故障节点标记为 slave（ <code>slaveof ip port</code> 命令），当故障节点恢复后会自动成为新的 master 的 slave 节点</li></ol></li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-搭建哨兵sentinel集群">2. 搭建哨兵（Sentinel）集群<a class="hash-link" href="#2-搭建哨兵sentinel集群" title="标题的直接链接">​</a></h4><ol><li><p>创建目录</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> sentinel1 sentinel2 sentinel3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>在每个目录下创建 sentinel.conf  文件，redis 目录下有 sentinel.conf 模板</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">echo</span><span class="token plain"> sentinel1 sentinel2 sentinel3 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">xargs</span><span class="token plain"> -t -n </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> redis-6.2.14/sentinel.conf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>修改以下配置</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># sentinel1 实例的端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">port </span><span class="token number" style="color:#36acaa">27001</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 声明 sentinel ip 地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sentinel announce-ip </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.136.131</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 指定主节点信息，quorum 为 2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sentinel monitor mymaster </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.136.131 </span><span class="token number" style="color:#36acaa">8001</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#slave 节点与 master 节点断开超时时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sentinel down-after-milliseconds mymaster </span><span class="token number" style="color:#36acaa">5000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 故障恢复超时时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sentinel failover-timeout mymaster </span><span class="token number" style="color:#36acaa">6000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#工作目录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">dir</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/opt/sentinel1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># sentinel2 实例的端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">port </span><span class="token number" style="color:#36acaa">27002</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 声明 sentinel ip 地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sentinel announce-ip </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.136.131</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 指定主节点信息，quorum 为 2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sentinel monitor mymaster </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.136.131 </span><span class="token number" style="color:#36acaa">8001</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#slave 节点与 master 节点断开超时时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sentinel down-after-milliseconds mymaster </span><span class="token number" style="color:#36acaa">5000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 故障恢复超时时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sentinel failover-timeout mymaster </span><span class="token number" style="color:#36acaa">6000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#工作目录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">dir</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/opt/sentinel2&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># sentinel3 实例的端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">port </span><span class="token number" style="color:#36acaa">27003</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 声明 sentinel ip 地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sentinel announce-ip </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.136.131</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 指定主节点信息，quorum 为 2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sentinel monitor mymaster </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.136.131 </span><span class="token number" style="color:#36acaa">8001</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#slave 节点与 master 节点断开超时时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sentinel down-after-milliseconds mymaster </span><span class="token number" style="color:#36acaa">5000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 故障恢复超时时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sentinel failover-timeout mymaster </span><span class="token number" style="color:#36acaa">6000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#工作目录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">dir</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/opt/sentinel2&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>启动</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">redis-sentinel sentinel1/sentinel.conf </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redis-sentinel sentinel2/sentinel.conf </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redis-sentinel sentinel3/sentinel.conf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-redistemplate-的哨兵模式">3. RedisTemplate 的哨兵模式<a class="hash-link" href="#3-redistemplate-的哨兵模式" title="标题的直接链接">​</a></h4><ul><li><p>在 Sentinel 集群监管下的 Redis 主从集群，其节点会因为自动故障转移而发生变化，Redis 的客户端必须感知这种变化及时更新连接信息。Spring 的 RedisTemplate 底层利用 lettuce 实现了节点的感知和自动切换</p></li><li><p>引入依赖</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.springframework.boot</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">spring-boot-starter-data-redis</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>配置 Sentinel 节点信息</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">spring</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">redis</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">sentinel</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">master</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> mymaster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">nodes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 192.168.136.131</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">27001</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 192.168.136.131</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">27002</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 192.168.136.131</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">27003</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>配置读写分离</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Bean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">LettuceClientConfigurationBuilderCustomizer</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">lettuceClientConfigurationBuilderCustomizer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> clientConfigurationBuilder </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> clientConfigurationBuilder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">readFrom</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ReadFrom</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">REPLICA_PREFERRED</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>这里的 <code>ReadFrom</code> 是配置 Redis 的读取策略，是一个枚举，包括下面选择:<ul><li>MASTER: 从主节点读取</li><li>MASTER_PREFERRED: 优先从master节点读取，master不可用才读取replica</li><li>REPLICA: 从 slave(replica) 节点读取</li><li>REPLICA_PREFERRED: 优先从 slave(replica) 节点读取，所有的 slave 都不可用才读取 master</li></ul></li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-redis-分片集群">4. Redis 分片集群<a class="hash-link" href="#4-redis-分片集群" title="标题的直接链接">​</a></h3><ul><li><p>主从和哨兵可以解决高可用、高并发读的问题。但是依然有两个问题没有解决</p><ol><li>海量数据存储问题</li><li>高并发写的问题</li></ol></li><li><p>使用<strong>分片集群</strong>可以解决上述问题，分片集群特征:</p><ul><li>集群中有多个 master，每个 master 保存不同数据</li><li>每个 master 都可以有多个 slave 节点</li><li>master 之间通过 <code>ping</code> 监测彼此健康状态</li><li>客户端请求可以访问集群任意节点，最终都会被转发到正确节点</li></ul><p><img loading="lazy" alt="image-20240716054142239" src="/assets/images/image-20240716054142239-c827e55599c22c598ca569ab9ce2283c.png" width="637" height="629" class="img_ev3q"></p></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-搭建分片集群">1. 搭建分片集群<a class="hash-link" href="#1-搭建分片集群" title="标题的直接链接">​</a></h4><ul><li><p>创建目录</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> cluster-master1 cluster-master2 cluster-master3 cluster-slave1 cluster-slave2 cluster-slave3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>为每个节点编写 redis.conf 配置文件</p><ul><li><p>例：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">port </span><span class="token number" style="color:#36acaa">8001</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 开启集群功能</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster-enabled </span><span class="token function" style="color:#d73a49">yes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#集群的配置文件名称，不需要我们创建，由redis自己维护</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster-config-file /opt/cluster-master1/nodes.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#节点心跳失败的超时可</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster-node-timeout </span><span class="token number" style="color:#36acaa">5000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#持久化文件存放目录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">dir</span><span class="token plain"> /opt/cluster-master1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 绑定地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">bind</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 让redis后台运行</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">daemonize </span><span class="token function" style="color:#d73a49">yes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#注洲的实例ip</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">replica-announce-ip </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.136.131</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#保护模式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected-mode no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#数据库数量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">databases </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#日志</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logfile /opt/cluster-master1/run.log</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>每个节点修改端口和目录位置即可</p></li></ul></li><li><p>启动</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 一键启动</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">printf</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;%s\n&#x27;</span><span class="token plain"> cluster-master1 cluster-master2 cluster-master3 cluster-slave1 cluster-slave2 cluster-slave3 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">xargs</span><span class="token plain"> -I</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> -t redis-server </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">/redis.conf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>创建集群</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">redis-cli --cluster create --cluster-replicas </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.136.131:8001 </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.136.131:8002 </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.136.131:8003 </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.136.131:8004 </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.136.131:8005 </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.136.131:8006</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>命令说明:<ul><li><code>redis-cli --cluster</code> : 代表集群操作命令</li><li><code>create</code>: 代表是创建集群</li><li><code>--replicas 1</code>或者 <code>--cluster-replicas 1</code>: 指定集群中每个 master 的副本个数为 1，此时<code>n = 节点总数 ÷ (replicas +1)</code>得到的就是 master 的数量。因此节点列表中的前 n 个就是master，其它节点都是 slave 节点，随机分配到不同 master</li></ul></li></ul></li><li><p>查看集群状态</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">redis-cli -p </span><span class="token number" style="color:#36acaa">8001</span><span class="token plain"> cluster nodes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>集群模式进入 redis-cli</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> redis-cli -c -p port</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-散列插槽">2. 散列插槽<a class="hash-link" href="#2-散列插槽" title="标题的直接链接">​</a></h4><ul><li><p>Redis 会把每一个 master 节点映射到 0~16383 共 16384 个插槽 (hashslot) 上</p><p><img loading="lazy" alt="image-20240716093526112" src="/assets/images/image-20240716093526112-a9e4d9c567cae81ff458e6225e2a3e30.png" width="659" height="169" class="img_ev3q"></p></li><li><p>数据 key 不是与节点绑定，而是与插槽绑定。redis 会根据 key 的<strong>有效部分</strong>计算插槽值，分两种情况:</p><ul><li>key 中包含 &quot;{}&quot;，且 &quot;{}&quot; 中至少包含 1 个字符， <strong>&quot;{}&quot;  中的部分是有效部分</strong><ul><li>通过这种方式，可以将同一类的数据使用相同的有效部分，从而将同一类数据固定的保存在同一个 Redis 实例</li></ul></li><li><strong>key 中不包含 &quot;{}&quot;，整个 key 都是有效部分</strong></li><li>例如: key 是 num，那么就根据 num 计算插槽值，key 如果是 {itcast}num，则根据 itcast 计算插槽值。计算方式是利用 <strong>CRC16算法</strong>得到一个 hash 值，然后对 16384 取余，得到的结果就是 slot 值</li></ul><p><img loading="lazy" alt="image-20240716094811565" src="/assets/images/image-20240716094811565-0dcce75fae9eca816d78ee8293f66e65.png" width="845" height="275" class="img_ev3q"></p></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-集群伸缩">3. 集群伸缩<a class="hash-link" href="#3-集群伸缩" title="标题的直接链接">​</a></h4><ul><li><p><code>redis-cli --cluster</code>提供了很多操作集群的命令,，比如添加节点、删除节点</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 查看 redis-cli --cluster 相关命令</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redis-cli --cluster </span><span class="token builtin class-name">help</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>给集群添加一个节点</p><ul><li><p>新建一个节点</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> cluster-node1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>redis.conf 配置文件</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">port </span><span class="token number" style="color:#36acaa">8007</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 开启集群功能</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster-enabled </span><span class="token function" style="color:#d73a49">yes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#集群的配置文件名称，不需要我们创建，由redis自己维护</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster-config-file /opt/cluster-node1/nodes.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#节点心跳失败的超时可</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster-node-timeout </span><span class="token number" style="color:#36acaa">5000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#持久化文件存放目录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">dir</span><span class="token plain"> /opt/cluster-node1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 绑定地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">bind</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 让redis后台运行</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">daemonize </span><span class="token function" style="color:#d73a49">yes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#注洲的实例ip</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">replica-announce-ip </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.136.131</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#保护模式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected-mode no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#数据库数量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">databases </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#日志</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logfile /opt/cluster-node1/run.log</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>启动</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">redis-server cluster-node1/redis.conf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>新节点加入集群</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">redis-cli --cluster add-node </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.136.131:8007 </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.136.131:8001</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 查看集群状态</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redis-cli -p </span><span class="token number" style="color:#36acaa">8001</span><span class="token plain"> cluster nodes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>给新节点分配插槽</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">redis-cli --cluster reshard </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.136.131:8001</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-故障转移">4. 故障转移<a class="hash-link" href="#4-故障转移" title="标题的直接链接">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 监控集群</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">watch</span><span class="token plain"> redis-cli -p </span><span class="token number" style="color:#36acaa">8001</span><span class="token plain"> cluster nodes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p>当集群中有一个 master 宕机时，redis 集群会自动故障转移</p><ol><li>首先是该实例与其它实例失去连接</li><li>然后是疑似宕机</li><li>最后是确定下线，自动提升一个slave为新的master</li></ol><p><img loading="lazy" alt="image-20240716130353734" src="/assets/images/image-20240716130353734-bf4971729b0d41137fb24ddd08d38cf6.png" width="1460" height="186" class="img_ev3q"></p></li><li><p>数据迁移（手动故障转移）</p><ul><li><p>在 slave 节点中执行 <code>cluster failover</code> 命令，可以手动让集群中的某个 master 宕机， slave 节点切换为 master 节点，实现无感知的数据迁移</p><p><img loading="lazy" alt="image-20240716131234525" src="/assets/images/image-20240716131234525-b8176147bd8146d90dc8d2d3bbe9b552.png" width="609" height="539" class="img_ev3q"></p></li><li><p>手动的 <code>Failover</code> 支持三种不同模式</p><ol><li>缺省: 默认的流程，如图1~6步</li><li>force: 省略了对 offset 的一致性校验</li><li>takeover: 直接执行第 5 步，忽略数据一致性、忽略 master 状态和其它 master 的意见</li></ol></li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="5-redistemplate-访问分片集群">5. RedisTemplate 访问分片集群<a class="hash-link" href="#5-redistemplate-访问分片集群" title="标题的直接链接">​</a></h4><ul><li><p>RedisTemplate 底层同样基于 lettuce 实现了分片集群的支持，而使用的步骤与哨兵模式基本一致</p><ul><li><p>引入依赖</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.springframework.boot</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">spring-boot-starter-data-redis</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>配置分片集群地址</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">spring</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">redis</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">cluster</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">nodes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 192.168.136.131</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">8001</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 192.168.136.131</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">8002</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 192.168.136.131</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">8003</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 192.168.136.131</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">8004</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 192.168.136.131</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">8005</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 192.168.136.131</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">8006</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 192.168.136.131</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">8007</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul></li></ul><ul><li><p>配置读写分离</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Bean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">LettuceClientConfigurationBuilderCustomizer</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">lettuceClientConfigurationBuilderCustomizer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> clientConfigurationBuilder </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> clientConfigurationBuilder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">readFrom</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ReadFrom</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">REPLICA_PREFERRED</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="二多级缓存">二、多级缓存<a class="hash-link" href="#二多级缓存" title="标题的直接链接">​</a></h2><ul><li><p>传统的缓存策略一般是请求到达 Tomcat 后，先查询 Redis，如果未命中则查询数据库，存在下面的问题</p><ul><li>请求要经过 Tomcat 处理，Tomcat 的性能成为整个系统的瓶颈</li><li>Redis 缓存失效时，会对数据库产生冲击</li></ul><p><img loading="lazy" alt="image-20240716134021495" src="/assets/images/image-20240716134021495-d63fd35b88c0a5cdace920a3b3879c40.png" width="1060" height="341" class="img_ev3q"></p></li><li><p>多级缓存就是充分利用请求处理的每个环节，分别添加缓存，减轻 Tomcat 压力，提升服务性能</p><p><img loading="lazy" alt="image-20240716134304829" src="/assets/images/image-20240716134304829-33ecbedbd0536c2dc0eac8fda0c9a7ec.png" width="1346" height="346" class="img_ev3q"></p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1--jvm-进程缓存">1.  JVM 进程缓存<a class="hash-link" href="#1--jvm-进程缓存" title="标题的直接链接">​</a></h3><ul><li><p>缓存在日常开发中启动至关重要的作用，由于是<strong>存储在内存</strong>中，数据的读取速度是非常快的，能大量减少对数据库的访问，减少数据库的压力。我们把缓存分为两类:</p><ul><li>分布式缓存，例如 Redis<ul><li>优点: 存储容量更大、可靠性更好、可以在集群间共享</li><li>缺点: 访问缓存有网络开销</li><li>场景: 缓存数据量较大、可靠性要求较高、需要在集群间共享</li></ul></li><li>进程本地缓存，例如 HashMap、GuavaCache<ul><li>优点: 读取本地内存，没有网络开销，速度更快</li><li>缺点: 存储容量有限、可靠性较低、无法共享</li><li>场景: 性能要求较高，缓存数据量较小</li></ul></li></ul></li><li><p>Caffeine 是一个基于 Java8 开发的，提供了近乎最佳命中率的高性能的本地缓存库。目前 Spring 内部的缓存使用的就是 Caffeine</p><ul><li><p>GitHub地址: <a href="https://github.com/ben-manes/caffeine" target="_blank" rel="noopener noreferrer">ben-manes/caffeine: A high performance caching library for Java (github.com)</a></p></li><li><p>引入依赖</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">com.github.ben-manes.caffeine</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">caffeine</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">3.1.8</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>配置 Caffeine</p><ul><li>Caffeine 提供了三种缓存驱逐策略，文档：<a href="https://github.com/ben-manes/caffeine/wiki/Eviction-zh-CN" target="_blank" rel="noopener noreferrer">Eviction zh CN · ben-manes/caffeine Wiki (github.com)</a><ol><li>基于容量: 设置缓存的数量上限</li><li>基于时间: 设置缓存的有效时间</li><li>基于引用: 设置缓存为软引用或弱引用，利用GC来回收缓存数据。性能较差，不建议使用</li></ol></li><li>在默认情况下，当一个缓存元素过期的时候，Caffeine 不会自动立即将其清理和驱逐。而是在一次读或写操作后，或者在
空闲时间完成对失效数据的驱逐</li></ul><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@Configuration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">CaffeineConfig</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Bean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">Cache</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">caffeineCache</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">Caffeine</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newBuilder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">expireAfterWrite</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">TimeUnit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">MINUTES</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">//设置缓存有效期，从最后一次写入开始计时</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">maximumSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">10_000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">//设置缓存大小上限</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>测试</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Autowired</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">Cache</span><span class="token plain"> caffeineCache</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">testCaffeine</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 存数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        caffeineCache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;key&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;value&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">//取数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">caffeineCache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getIfPresent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;key&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 如果缓存中没有 key 对应的数据，则调用回调函数获取数据（可以从数据库查询）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Object</span><span class="token plain"> object </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> caffeineCache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;key1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> k </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;dbValue&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">object</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-lua-脚本语言">2. Lua 脚本语言<a class="hash-link" href="#2-lua-脚本语言" title="标题的直接链接">​</a></h3><ul><li><p>在 NGINX 中可以使用 Lua 脚本语言编写业务代码进行开发</p></li><li><p>Lua 是一种轻量小巧的脚本语言，用标准C语言编写并以源代码形式开放，其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。官网: <a href="https://www.lua.org/" target="_blank" rel="noopener noreferrer">The Programming Language Lua</a></p></li><li><p>centos 中自带 lua 运行环境</p><ul><li><p>创建 hello.lua</p><div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;hello,lua&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>运行 hello.lua</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">lua hello.lua</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul></li><li><p>Lua 入门 ：<a href="https://www.runoob.com/lua/lua-tutorial.html" target="_blank" rel="noopener noreferrer">Lua 教程 | 菜鸟教程 (runoob.com)</a></p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-多级缓存">3. 多级缓存<a class="hash-link" href="#3-多级缓存" title="标题的直接链接">​</a></h3><p><img loading="lazy" alt="image-20240717163913445" src="/assets/images/image-20240717163913445-3cf4208f2ff73973fca6d1342dad0b56.png" width="1557" height="739" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="openresty">OpenResty<a class="hash-link" href="#openresty" title="标题的直接链接">​</a></h4><ul><li><p>OpenResty 是一个基于 Nginx 的高性能 Web 平台，用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用 Web 服务和动态网关。具备下列特点:</p><ul><li>具备 Nginx 的完整功能</li><li>基于 Lua 语言进行扩展，集成了大量精良的 Lua 库、第三方模块</li><li>允许使用Lua自定义业务逻辑、自定义库</li></ul></li><li><p>官方网站: <a href="https://openresty.org/cn/" target="_blank" rel="noopener noreferrer">OpenResty® - 开源官方站</a></p></li><li><p>可以使用 OpenResty + lua 实现对请求的处理及业务的开发，如查 Redis、查数据库、查 Tomcat等</p><ul><li><p>OpenResty 提供了各种 API 用来获取不同类型的请求参数</p><div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- 在 lua 脚本中使用 NGINX 发请求的 api</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ngx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">local</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">captuer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>OpenResty 目录下的 lualib 目录存放了相关的库，需要在 nginx.conf  的 http 配置快下配置包路径</p><div class="language-nginx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-nginx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#lua 模块</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token directive keyword" style="color:#00009f">lua_package_path</span><span class="token directive"> </span><span class="token directive string" style="color:#e3116c">&quot;/usr/local/openresty/lualib/?.lua;;&quot;</span><span class="token directive"></span><br></span><span class="token-line" style="color:#393A34"><span class="token directive"></span><span class="token directive comment" style="color:#999988;font-style:italic">#c模块</span><span class="token directive"></span><br></span><span class="token-line" style="color:#393A34"><span class="token directive">lua_package_cpath </span><span class="token directive string" style="color:#e3116c">&quot;/usr/local/openresty/lualib/?.so;;&quot;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>操作 Redis 的模块<code>lualib/resty/redis.lua</code>，</li></ul></li></ul></li><li><p>NGINX 支持的负载均衡算法</p><p><strong>轮询（Round Robin）</strong>：</p><ul><li>默认负载均衡算法，按照顺序将请求逐个分配给不同的后端服务器。每个服务器的请求量大致相同。</li></ul><p><strong>权重轮询（Weighted Round Robin）</strong>：</p><ul><li><p>在轮询的基础上，为每个后端服务器分配权重。权重越高，接收到的请求数越多。适用于后端服务器性能不均的情况。</p><div class="language-nginx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-nginx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token directive keyword" style="color:#00009f">upstream</span><span class="token directive"> backend</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token directive keyword" style="color:#00009f">server</span><span class="token directive"> backend1.example.com weight=3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token directive keyword" style="color:#00009f">server</span><span class="token directive"> backend2.example.com weight=1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><p><strong>最少连接（Least Connections）</strong>：</p><ul><li><p>将新请求分配给当前连接数最少的服务器，适用于处理时间长短不一的请求。</p><div class="language-nginx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-nginx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token directive keyword" style="color:#00009f">upstream</span><span class="token directive"> backend</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token directive keyword" style="color:#00009f">least_conn</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token directive keyword" style="color:#00009f">server</span><span class="token directive"> backend1.example.com</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token directive keyword" style="color:#00009f">server</span><span class="token directive"> backend2.example.com</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><p><strong>最少时间（Least Time）</strong>：</p><ul><li>将新请求分配给平均响应时间最短且活动连接数最少的服务器。适用于需要考虑服务器响应时间的场景。</li></ul><p><strong>IP哈希（IP Hash）</strong>：</p><ul><li><p>根据客户端 IP 地址的哈希值分配请求，使同一客户端的请求总是转发到同一台后端服务器。适用于需要会话保持的情况。</p><div class="language-nginx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-nginx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token directive keyword" style="color:#00009f">upstream</span><span class="token directive"> backend</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token directive keyword" style="color:#00009f">ip_hash</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token directive keyword" style="color:#00009f">server</span><span class="token directive"> backend1.example.com</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token directive keyword" style="color:#00009f">server</span><span class="token directive"> backend2.example.com</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><p><strong>URI哈希（URI Hash）</strong>：</p><ul><li><p>根据请求 URI 的哈希值分配请求，使相同 URI 的请求总是转发到同一台后端服务器。适用于需要将相同资源请求分配给同一服务器的情况。</p><div class="language-nginx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-nginx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token directive keyword" style="color:#00009f">upstream</span><span class="token directive"> backend</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token directive keyword" style="color:#00009f">hash</span><span class="token directive"> </span><span class="token directive variable" style="color:#36acaa">$request_uri</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token directive keyword" style="color:#00009f">server</span><span class="token directive"> backend1.example.com</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token directive keyword" style="color:#00009f">server</span><span class="token directive"> backend2.example.com</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><p><strong>公平（Fair）</strong>：</p><ul><li>根据后端服务器的响应时间来分配请求，响应时间短的服务器分配更多请求。需要第三方模块 <code>upstream_fair</code>。</li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="冷启动与缓存预热">冷启动与缓存预热<a class="hash-link" href="#冷启动与缓存预热" title="标题的直接链接">​</a></h4><ul><li><p><strong>冷启动</strong></p><ul><li>服务刚刚启动时，Redis 中并没有缓存，如果所有数据都在第一次查询时添加缓存，可能会给数据库带来较大压力</li></ul></li><li><p><strong>缓存预热</strong></p><ul><li><p>在实际开发中，我们可以利用大数据统计用户访问的热点数据，在项目启动时将这些热点数据提前查询并保存到 Redis 中</p></li><li><p>实现数据预热</p><ul><li>实现<code>InitializingBean</code> 接口中 <code>afterPropertiesSet()</code>，在实现类 bean 加载完且依赖注入完成后就会执行 <code>afterPropertiesSet()</code>方法，因此可以在该方法中编写数据缓存逻辑，达到在项目启动时将数据缓存到 Redis</li></ul><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@Component</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">RedisHandler</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">implements</span><span class="token plain"> </span><span class="token class-name">InitializingBean</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Autowired</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">StringRedisTemplate</span><span class="token plain"> stringRedisTemplate</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">afterPropertiesSet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">throws</span><span class="token plain"> </span><span class="token class-name">Exception</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">//编写数据预热逻辑</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="nginx-本地缓存">NGINX 本地缓存<a class="hash-link" href="#nginx-本地缓存" title="标题的直接链接">​</a></h4><ul><li><p>OpenResty 为 Nginx 提供了shard dict 的功能，可以在 nginx 的多个 worker 之间共享数据，实现缓存功能</p><ul><li><p>需要在 nginx.conf  的 http 配置快下配置开启 shard dict 功能</p><div class="language-nginx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-nginx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 添加共享词典，本地缓存,名称叫做: item_cache，大小150m</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token directive keyword" style="color:#00009f">lua_shared_dict</span><span class="token directive"> item_cache </span><span class="token directive number" style="color:#36acaa">150m</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>在 lua 脚本中使用共享词典</p><div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- 获取本地缓存对象</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">local</span><span class="token plain"> item_cache </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ngx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">shared</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">item_cache</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">--存储，指定key、value、过期时间，单位s，默认为代表永不过期</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">item_cache</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;key&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&#x27;value&#x27;</span><span class="token plain">，</span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 读取</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">local</span><span class="token plain"> val</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">item_cache</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;key&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-缓存同步策略">4. 缓存同步策略<a class="hash-link" href="#4-缓存同步策略" title="标题的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="数据同步策略">数据同步策略<a class="hash-link" href="#数据同步策略" title="标题的直接链接">​</a></h4><ul><li><p>缓存数据同步的常见方式有三种</p><ol><li><p>设置有效期: 给缓存设置有效期，到期后自动删除。再次查询时更新</p><ul><li>优势: 简单、方便</li><li>缺点: 时效性差，缓存过期之前可能不一致场景:更新频率较低，时效性要求低的业务</li></ul></li><li><p>同步双写: 在修改数据库的同时，直接修改缓存</p><ul><li>优势: 时效性强，缓存与数据库强一致</li><li>缺点: 有代码侵入，耦合度高;场景:对一致性、时效性要求较高的缓存数据</li></ul></li><li><p>异步通知: 修改数据库时发送事件通知，相关服务监听到通知后修改缓存数据优势:低耦合，可以同时通知多个缓存服务</p><ul><li><p>缺点: 时效性一般，可能存在中间不一致状态</p></li><li><p>场景: 时效性要求一般，有多个服务需要同步</p></li><li><p>基于 MQ 的异步通知</p><p><img loading="lazy" alt="image-20240717152142349" src="/assets/images/image-20240717152142349-15c5a0df71350d5440032d572ad83dd0.png" width="1355" height="636" class="img_ev3q"></p></li><li><p>基于 Canal 的异步通知</p><p><img loading="lazy" alt="image-20240717152343368" src="/assets/images/image-20240717152343368-15e13d3d0666d950adc66e338b72ba67.png" width="1222" height="490" class="img_ev3q"></p></li></ul></li></ol></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="canal">Canal<a class="hash-link" href="#canal" title="标题的直接链接">​</a></h4><ul><li><p>Canal，译意为水道/管道/沟渠，canal 是阿里巴巴旗下的一款开源项目，基于Java 开发。</p><ul><li>功能：基于数据库增量日志解析，提供增量数据订阅和消费</li><li>GitHub:<a href="https://github.com/alibaba/canal" target="_blank" rel="noopener noreferrer">alibaba/canal: 阿里巴巴 MySQL binlog 增量订阅&amp;消费组件 (github.com)</a></li></ul><p><img loading="lazy" alt="img" src="/assets/images/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f32303139313130343130313733353934372e706e67-9c8a4317ee72ce7622c7a28b8904b23b.bin" width="1361" height="717" class="img_ev3q"></p></li></ul><h5 class="anchor anchorWithStickyNavbar_LWe7" id="工作原理">工作原理<a class="hash-link" href="#工作原理" title="标题的直接链接">​</a></h5><ul><li><p><strong>MySQL 主备复制原理</strong></p><ul><li>MySQL master 将数据变更写入二进制日志( binary log, 其中记录叫做二进制日志事件binary log events，可以通过 show binlog events 进行查看)</li><li>MySQL slave 将 master 的 binary log events 拷贝到它的中继日志(relay log)</li><li>MySQL slave 重放 relay log 中事件，将数据变更反映它自己的数据</li></ul></li><li><p><strong>canal 工作原理</strong></p><ul><li>canal 模拟 MySQL slave 的交互协议，伪装自己为 MySQL slave ，向 MySQL master 发送dump 协议</li><li>MySQL master 收到 dump 请求，开始推送 binary log 给 slave (即 canal )</li><li>canal 解析 binary log 对象(原始为 byte 流)</li></ul></li></ul><h5 class="anchor anchorWithStickyNavbar_LWe7" id="安装-canal">安装 Canal<a class="hash-link" href="#安装-canal" title="标题的直接链接">​</a></h5><ul><li>具体安装可参考：<a href="https://github.com/alibaba/canal/wiki/QuickStart" target="_blank" rel="noopener noreferrer">QuickStart · alibaba/canal Wiki (github.com)</a></li></ul><h5 class="anchor anchorWithStickyNavbar_LWe7" id="canal-客户端">Canal 客户端<a class="hash-link" href="#canal-客户端" title="标题的直接链接">​</a></h5><ul><li><p>Canal 提供了各种语言的客户端，当 Canal 监听到 binlog 变化时，会通知 Canal 的客户端</p><p><img loading="lazy" alt="image-20240717155240894" src="/assets/images/image-20240717155240894-5e1a66c7cf9f9ccf43763e3561f15e97.png" width="1472" height="531" class="img_ev3q"></p></li><li><p>由于 Canal 原生的客户端 api 使用起来不方便，可以使用第三方可以的 Canal 客户端</p><ul><li>canal-starter: <a href="https://github.com/NormanGyllenhaal/canal-client" target="_blank" rel="noopener noreferrer">NormanGyllenhaal/canal-client: spring boot canal starter 易用的canal 客户端 canal client (github.com)</a></li><li>具体使用可参考：<a href="https://github.com/NormanGyllenhaal/canal-client/tree/master/canal-example/src" target="_blank" rel="noopener noreferrer">canal-client/canal-example/src at master · NormanGyllenhaal/canal-client (github.com)</a></li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="三redis-最佳实践使用经验">三、Redis 最佳实践（使用经验）<a class="hash-link" href="#三redis-最佳实践使用经验" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="redis-键值设计">Redis 键值设计<a class="hash-link" href="#redis-键值设计" title="标题的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="优雅的key结构">优雅的key结构<a class="hash-link" href="#优雅的key结构" title="标题的直接链接">​</a></h4><ul><li><p>Redis 的 Key 虽然可以自定义，但最好遵循下面的几个最佳实践约定</p><ol><li>遵循基本格式: <code>[业务名称]:[数据名]:[id]</code></li><li>长度不超过 44 字节</li><li>不包含特殊字符</li></ol></li><li><p>优点:</p><ul><li><p>可读性强</p></li><li><p>避免 key 冲突</p></li><li><p>方便管理</p></li><li><p>更节省内存: key 是 string 类型，底层编码包含 int、embstr 和 raw 三种。embstr 在小于44字节使用，会采用连续内存空间，内存占用更小，超过 44 字节就会使用 raw 编码</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 查看 key 类型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">type</span><span class="token plain"> key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 查看 key 底层编码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OBJECT encoding key</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="拒绝-bigkey">拒绝 BigKey<a class="hash-link" href="#拒绝-bigkey" title="标题的直接链接">​</a></h4><ul><li><p>BigKey 通常以 <strong>Key 的大小</strong>和 <strong>Key 中成员的数量</strong>来综合判定，例如:</p><ul><li>Key 本身的数据量过大: 一个 String 类型的 Key，它的值为 5 MB</li><li>Key 中的成员数过多: 一个 ZSET 类型的 Key，它的成员数量为10,000个</li><li>Key 中成员的数据量过大: 一个 Hash 类型的 Key，它的成员数量虽然只有 1,000个 但这些成员的 Value (值)总大小为 100 MB</li></ul></li><li><p>推荐值:</p><ul><li>单个 key 的 value 小于 10KB</li><li>对于集合类型的 key，建议元素数量小于 1000</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 查看 key 对应 value 占用的内存大小，此命令对 cup 占用高，不推荐使用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">memory usege key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 查看 key 对应 value 的长度</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">STRLEN key</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong>BigKey 的危害</strong></p><ol><li>网络阻塞<ul><li>对BigKey执行读请求时，少量的 QPS 就可能导致带宽使用率被占满，导致 Redis 实例，乃至所在物理机变慢</li></ul></li><li>数据倾斜<ul><li>BigKey 所在的 Redis 实例内存使用率远超其他实例，无法使数据分片的内存资源达到均衡</li></ul></li><li>Redis 阻塞<ul><li>对元素较多的 hash、list、zset 等做运算会耗时较旧，使主线程被阻塞</li></ul></li><li>CPU压力<ul><li>对 BigKey 的数据序列化和反序列化会导致 CPU 的使用率飙升，影响 Redis 实例和本机其它应用</li></ul></li></ol></li><li><p><strong>如何发现 BigKey</strong></p><ul><li><p><code>redis-cli --bigkeys</code></p><ul><li><p>利用 <code>redis-cli</code> 提供的 <code>--bigkeys</code> 参数，可以遍历分析所有key，并返回Key的整体统计信息与每个数据的Top1的big key</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redis-cli -a </span><span class="token number" style="color:#36acaa">222333</span><span class="token plain"> -p </span><span class="token number" style="color:#36acaa">7001</span><span class="token plain"> --bigkeys</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul></li><li><p><code>scan</code> 扫描，还有 <code>hscan</code>、<code>sscan</code>、<code>zscan</code> 等</p><ul><li><p>自己编程，利用 <code>scan</code> 命令扫描 Redis 中的所有 key，利用 <code>strlen</code>、<code>hlen</code> 、<code>llen</code>、<code>scard</code>、<code>zcard</code>等命令判断 key 的长度(此处不建议使用 <code>MEMORY USAGE</code>)</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SCAN cursor </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">MATCH pattern</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">COUNT count</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">TYPE type</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul></li><li><p>第三方工具</p><ul><li>利用第三方工具，如 Redis-Rdb-Tools 分析 RDB 快照文件，全面分析内存使用情况<ul><li><a href="https://github.com/sripathikrishnan/redis-rdb-tools" target="_blank" rel="noopener noreferrer">sripathikrishnan/redis-rdb-tools: Parse Redis dump.rdb files, Analyze Memory, and Export Data to JSON (github.com)</a></li></ul></li></ul></li><li><p>网络监控</p><ul><li>自定义工具，监控进出 Redis 的网络数据，超出预警值时主动告警</li></ul></li></ul></li><li><p><strong>如何删除 BigKey</strong></p><ul><li>BigKey 内存占用较多，即便是删除这样的key也需要耗费很长时间，导致 Redis 主线程阻塞，引发一系列问题。</li><li>redis 3.0 及以下版本<ul><li>如果是集合类型，则遍历 BigKey 的元素，先逐个删除子元素，最后删除BigKey</li></ul></li><li>Redis 4.0以后<ul><li>Redis 在 4.0 后提供了异步删除的命令: <code>unlink</code></li></ul></li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="恰当的数据类型">恰当的数据类型<a class="hash-link" href="#恰当的数据类型" title="标题的直接链接">​</a></h4><ul><li>存一个对象可以有三种储存方式<ol><li>以 json 字符串方式存储<ul><li>优点: 实现简单粗暴</li><li>缺点: 数据耦合，不够灵活</li></ul></li><li>将字段打散，以 string 方式 储存<ul><li>优点: 可以灵活访问对象任意字段</li><li>缺点: 占用空间大、没办法做统一控制</li></ul></li><li>以 hash 方式储存<ul><li>优点: 底层使用 ziplist，空间占用小，可以灵活访问对象的任意字段</li><li>缺点: 代码相对复杂</li><li><strong>存在问题</strong>：假如有 hash 类型的 key，其中有 100 万对 field 和 value，field 是自增 id，这个 key 存在什么问题?如何优化?<ul><li>hash 的 entry 数量超过 500 时，会使用哈希表而不是 ZipList，内存占用较多</li><li>优化<ol><li>可以通过 <code>hash-max-ziplist-entries</code> 配置entry上限。但是如果 entry 过多就会导致 BigKey 问题</li><li>将 hash 拆分为 string 类型进行存储。可以解决 BigKey，但是 string 结构底层没有太多内存优化，内存占用较多，且想要批量获取这些数据比较麻烦</li><li>拆分为小的 hash，将 <code>id/100</code> 作为key，将 <code>id % 100</code> 作为 field，这样每100 个元素为一个 Hash</li></ol></li></ul></li></ul></li></ol></li><li>Value 的最佳实践:<ul><li>合理的拆分数据，拒绝 BigKey</li><li>选择合适数据结构</li><li>Hash 结构的 entry 数量不要超过 1000</li><li>设置合理的超时时间</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="批处理优化">批处理优化<a class="hash-link" href="#批处理优化" title="标题的直接链接">​</a></h3><ul><li><p>单个命令的执行流程</p><ul><li><p>一次命令的响应时间 = 1次往返的网络传输耗时 + 1次Redis执行命令耗时</p></li><li><p>网络传输耗时往往大于 Redis 执行命令耗时，甚至是数量级的差别</p><p><img loading="lazy" alt="image-20240718001857217" src="/assets/images/image-20240718001857217-36f003cbf9e812a4808a93f95e5d1f02.png" width="841" height="275" class="img_ev3q"></p></li></ul></li><li><p>N条命令依次执行</p><ul><li><p>N次命令的响应时间= N次往返的网络传输耗时 + N次Redis执行命令耗时</p></li><li><p>N网络传输耗时导致耗时大大增加</p><p><img loading="lazy" alt="image-20240718002849152" src="/assets/images/image-20240718002849152-18a3c239695943ad4e68c9a37fae6459.png" width="836" height="302" class="img_ev3q"></p></li></ul></li><li><p>N条命令批量执行</p><ul><li><p>N次命令的响应时间 = 1次往返的网络传输耗时 + N次Redis执行命令耗时</p></li><li><p>批量执行效率会大大增加</p><p><img loading="lazy" alt="image-20240718003008881" src="/assets/images/image-20240718003008881-323bc415122eac8ddff31fcf33b3546e.png" width="847" height="292" class="img_ev3q"></p></li></ul></li></ul><h5 class="anchor anchorWithStickyNavbar_LWe7" id="redis-原生批处理mset-等">Redis 原生批处理（MSET 等）<a class="hash-link" href="#redis-原生批处理mset-等" title="标题的直接链接">​</a></h5><ul><li><p>Redis 提供了很多 <code>Mxxx</code> 这样的命令，可以实现批量插入数据，例如: <code>mset</code>、<code>hmset</code></p><ul><li>不要在一次批处理中传输太多命令，否则单次命令占用带宽过多，会导致网络阻塞，命令太多可以分多次批处理</li></ul><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">testMset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stringRedisTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">opsForValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">multiSet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;key1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;value1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;key2&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;value2&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><h5 class="anchor anchorWithStickyNavbar_LWe7" id="pipeline">Pipeline<a class="hash-link" href="#pipeline" title="标题的直接链接">​</a></h5><ul><li><code>MSET</code> 虽然可以批处理，但是却只能操作部分数据类型，因此如果有对复杂数据类型的批处理需要，建议使用 Pipeline 功能</li><li>可以将多条命令放入 Pipeline 中，然后一次性发送到 Redis 执行</li></ul><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">testPipeline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stringRedisTemplate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">executePipelined</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">RedisCallback</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> connection </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            connection</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">openPipeline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            connection</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">stringCommands</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;key1&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;value1&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            connection</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">hashCommands</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">hSet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;hashKey&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;hashKey1&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;hashValue1&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            connection</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setCommands</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sAdd</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;setKey&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;setValue1&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;setValue2&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            connection</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">zSetCommands</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">zAdd</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;zsetKey&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;zsetValue1&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            connection</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">listCommands</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">lPush</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;listKey&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;listValue1&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            connection</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">closePipeline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p>批量处理的方案:</p><ol><li>原生的M操作</li><li>Pipeline批处理</li></ol><ul><li>注意事项:<ul><li>批处理时不建议一次携带太多命令</li><li>Pipeline的多个命令之间不具备原子性</li></ul></li></ul></li></ul><h5 class="anchor anchorWithStickyNavbar_LWe7" id="集群下的批处理">集群下的批处理<a class="hash-link" href="#集群下的批处理" title="标题的直接链接">​</a></h5><ul><li><p>如 <code>MSET</code> 或 <code>Pipeline</code> 这样的批处理需要在一次请求中携带多条命令，而此时如果 Redis 是一个集群，那批处理命令的多个 key 必须落在一个插槽中，否则就会导致执行失败</p></li><li><p>解决方案</p><table><thead><tr><th></th><th>串行命令</th><th>串行slot</th><th>并行slot</th><th>hash_tag</th></tr></thead><tbody><tr><td>实现思路</td><td>for循环遍历，依次执行每个命令</td><td>在客户端计算每个 key 的 slot，将 slot 一致分为一组，每组都利用 Pipeline 批处理。<strong>串行执行各组命令</strong></td><td>在客户端计算每个 key 的 slot，将 slot 一致分为一组，每组都利用 Pipeline 批处理。<strong>并行执行各组命令</strong></td><td>将所有 key 设置相同的 <strong>hash_tag</strong>，则所有 key 的 slot 一定相同<br>**hash_tag：key 的 {} 中的有效部分</td></tr><tr><td>耗时</td><td>N次网络耗时+N次命令耗时</td><td>m次网络耗时 +N次命令耗时<br>m= key的slot个数</td><td>1次网络耗时 + N次命令耗时</td><td>1次网络耗时 +N次命令耗时</td></tr><tr><td>优点</td><td>实现简单</td><td>耗时较短</td><td>耗时非常短</td><td>耗时非常短、实现简单</td></tr><tr><td>缺点</td><td>耗时非常久</td><td>实现稍复杂<br>slot越多，耗时越久</td><td>实现复杂</td><td>容易出现数据倾斜，即大量 key 存储在同一个插槽</td></tr></tbody></table></li><li><p><code>StringRedisTemplate</code> 对集群下的批处理失败问题进行了解决，且使用的 <strong>并行slot</strong> 的解决方案，因此推荐使用 <code>StringRedisTemplate</code>  来做集群下的批处理</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="服务端优化">服务端优化<a class="hash-link" href="#服务端优化" title="标题的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="持久化配置">持久化配置<a class="hash-link" href="#持久化配置" title="标题的直接链接">​</a></h4><ul><li><p>Redis 的持久化虽然可以保证数据安全，但也会带来很多额外的开销，因此持久化请遵循下列建议:</p><ol><li><p>用来做缓存的 Redis 实例尽量不要开启持久化功能</p></li><li><p>建议关闭 RDB 持久化功能，使用 AOF 持久化</p></li><li><p>利用脚本定期在 slave 节点做 RDB，实现数据备份</p></li><li><p>设置合理的 AOF 文件的 rewrite 阈值，避免频繁的 bgrewrite（重写）</p></li><li><p>配置 <code>no-appendfsync-on-rewrite=yes</code>，禁止在 rewrite 期间做 AOF ，避免因 AOF 引起的阻塞</p><p><img loading="lazy" alt="image-20240718015832159" src="/assets/images/image-20240718015832159-1ab5c7a2d572649f5281041998dd74fc.png" width="434" height="390" class="img_ev3q"></p></li></ol></li><li><p>部署有关建议:</p><ul><li>Redis实例的物理机要预留足够内存，应对 fork 和 rewrite</li><li>单个Redis实例内存上限不要太大，例如4G或8G。可以加快 fork 的速度、减少主从同步、数据迁移压力</li><li>不要与 CPU 密集型应用部署在一起</li><li>不要与高硬盘负载应用一起部署。例如: 数据库、消息队列</li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="慢查询">慢查询<a class="hash-link" href="#慢查询" title="标题的直接链接">​</a></h4><ul><li><p>慢查询: 在 Redis 执行时耗时超过某个闯值的命令，称为慢查询</p></li><li><p>慢查询的阈值可以通过配置指定</p><ul><li><code>slowlog-log-slower-than</code>: 慢查询阈值，单位是微秒。默认是10000，建议1000</li></ul></li><li><p>慢查询会被放入<strong>慢查询日志</strong>中，日志的长度有上限，可以通过配置指定</p><ul><li><code>slowlog-max-len</code>: 慢查询日志(本质是一个队列)的长度。默认是128，建议1000</li></ul></li><li><p>可以修改配置文件达到永久生效，也可以使用以下命令动态修改配置（重启会失效）</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">config </span><span class="token builtin class-name">set</span><span class="token plain"> slowlog-log-slower-than </span><span class="token number" style="color:#36acaa">1000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config </span><span class="token builtin class-name">set</span><span class="token plain"> slowlog-max-len </span><span class="token number" style="color:#36acaa">1000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>查看慢查询日志列表:</p><ul><li><code>slowlog len</code>: 查询慢查询日志长度</li><li><code>slowlog get [n]</code>: 读取 n 条慢查询日志</li><li><code>slowlog reset</code>: 清空慢查询列表</li></ul></li><li><p>也可以通过 Redis 的桌面客户端 RESP.app 查看</p><p><img loading="lazy" alt="image-20240718021958161" src="/assets/images/image-20240718021958161-96912b51e7c863040a7b722743a17318.png" width="1315" height="341" class="img_ev3q"></p></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="命令及安全配置">命令及安全配置<a class="hash-link" href="#命令及安全配置" title="标题的直接链接">​</a></h4><ul><li>Redis 会绑定在 0.0.0.0:6379，这样将会将 Redis 服务暴露到公网上，而 Redis 如果没有做身份认证，会出现严重的安全漏洞<ul><li>漏洞重现方式: <a href="https://cloud.tencent.com/developer/article/1039000" target="_blank" rel="noopener noreferrer">Redis未授权访问配合SSH key文件利用分析-腾讯云开发者社区-腾讯云 (tencent.com)</a></li><li>漏洞出现的核心的原因有以下几点:<ul><li>Redis 未设置密码</li><li>利用了 Redis 的 <code>config set</code> 命令动态修改Redis配置</li><li>使用了Root账号权限启动Redis</li></ul></li></ul></li><li>为了避免这样的漏洞，这里给出一些建议:<ol><li>Redis一定要设置密码</li><li>禁止线上使用下面命令:<code>keys</code>、<code>flushall</code> 、<code>flushdb</code>、<code>config set</code> 等命令。可以利用<code>rename-command</code>修改命令名称，达到禁用目的</li><li>bind: 限制网卡，禁止外网网卡访问</li><li>开启防火墙</li><li>不要使用 Root 账户启动 Redis</li><li>尽量不是有默认的端口</li></ol></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="内存配置">内存配置<a class="hash-link" href="#内存配置" title="标题的直接链接">​</a></h4><ul><li><p>当 Redis 内存不足时，可能导致 Key 频繁被删除、响应时间变长、QPS 不稳定等问题。当内存使用率达到 90% 以上时就需要我们警惕，并快速定位到内存占用的原因</p><table><thead><tr><th align="center">内存占用</th><th>说明</th></tr></thead><tbody><tr><td align="center">数据内存</td><td>是 Redis 最主要的部分，存储 Redis 的键值信息。主要问题是 BigKey 问题、内存碎片问题</td></tr><tr><td align="center">进程内存</td><td>Redis 主进程本身运行肯定需要占用内存，如代码、常量池等等;这部分内存大约几兆，在大多数生产环境中与 Redis 数据占用的内存相比可以忽略</td></tr><tr><td align="center">缓冲区内存</td><td>一般包括<strong>客户端缓冲区</strong>、<strong>AOF 缓冲区</strong>、<strong>复制缓冲区等</strong>。客户端缓冲区又包括输入缓冲区和输出缓冲区两种。这部分内存占用波动较大，不当使用 BigKey，可能导致内存溢出</td></tr></tbody></table></li><li><p>Redis 提供了一些命令，可以查看到 Redis 目前的内存分配状态，也可以通过 Redis 的桌面客户端 RESP.app 查看</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">info memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">memory stats</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>内存缓冲区常见的有三种:</p><ol><li><p>复制缓冲区: 主从复制的repl_backlog_buf，如果太小可能导致频繁的全量复制，影响性能。通过 <code>repl-backlogsize</code> 来设置，默认 1mb</p></li><li><p>AOF 缓冲区: AOF 刷盘之前的缓存区域，AOF 执行 rewrite 的缓冲区。无法设置容量上限</p></li><li><p>客户端缓冲区: 分为<strong>输入缓冲区</strong>和<strong>输出缓冲区</strong>，输入缓冲区最大 1G 且不能设置。输出缓冲区可以设置</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 输出缓冲区配置项</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client-output-buffer-limit </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">class</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">hard limit</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">soft limit</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">soft seconds</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>&lt;class&gt;</code> : 客户端类型<ul><li>normal：普通客户端</li><li>replica：主从复制客户端</li><li>pubsub：pubsub 客户端</li></ul></li><li><code>&lt;hard limit&gt;</code> : 缓冲区上限在超过 limit 后断开客户端</li><li><code>&lt;soft limit&gt; &lt;soft seconds&gt;</code> : 缓冲区上限，在超过 soft limit 并且持续了 soft seconds 秒后断开客户端</li></ul><p><img loading="lazy" alt="image-20240718032035597" src="/assets/images/image-20240718032035597-2630f5f496123eb5f99caad2e93ec9d8.png" width="1326" height="882" class="img_ev3q"></p><ul><li><p>Reids 提供了查看客户端信息命令，也可以通过 Redis 的桌面客户端 RESP.app 查看</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">info clients</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client list</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>通过检测客户端信息，对客户端缓冲区进行判断，是否出现故障，以及时处理</p></li></ul></li></ol></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="集群最佳实践">集群最佳实践<a class="hash-link" href="#集群最佳实践" title="标题的直接链接">​</a></h3><ul><li>集群虽然具备高可用特性，能实现自动故障恢复，但是如果使用不当，也会存在一些问题:<ol><li>集群完整性问题</li><li>集群带宽问题</li><li>数据倾斜问题</li><li>客户端性能问题</li><li>命令的集群兼容性问题</li><li>lua 和事务问题</li></ol></li></ul><p><strong>集群完整性问题</strong></p><ul><li><p>在 Redis 的默认配置中有一个配置<code>cluster-require-full-coverage</code>，如果发现任意一个插槽不可用，则整个集群都会停止对外服务:</p><p><img loading="lazy" alt="image-20240718141258577" src="/assets/images/image-20240718141258577-9d4e0ce636a8042a908caed2207d462b.png" width="1422" height="306" class="img_ev3q"></p></li><li><p>为了保证高可用特性，建议将 <code>cluster-require-full-coverage</code> 配置为 false</p><ul><li>这样即使有节点宕机，宕机节点对应的插槽无法存数据，插槽正常的节点上依然存数据，不会停止整个集群服务</li></ul></li></ul><p><strong>集群带宽问题</strong></p><ul><li><p>集群节点之间会不断的互相 <code>Ping</code> 来确定集群中其它节点的状态。每次 <code>Ping</code> 携带的信息至少包括:</p><ul><li>插槽信息</li><li>集群状态信息</li></ul></li><li><p>当集群中节点越多，集群状态信息数据量也越大，10 个节点的相关信息可能达到 1kb，此时每次集群互通需要的带宽会非常高</p><ul><li>解决带宽高途径<ol><li>避免大集群，集群节点数不要太多，最好少于 1000，如果业务庞大，则建立多个集群</li><li>避免在单个物理机中运行太多 Redis 实例</li><li>配置合适的 <code>cluster-node-timeout</code> 值</li></ol></li></ul></li></ul><p><strong>选择集群还是主从</strong></p><ul><li>单体 Redis (主从 Redis )已经能达到万级别的 QPS，并且也具备很强的高可用特性。如果主从能满足业务需求的情况下，尽量不搭建 Redis 集群</li></ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Redis/RedisBusinessScenarios"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">基于 Redis 的业务场景</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Redis/ReidsPrinciple"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">Redis 原理</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#一分布式缓存" class="table-of-contents__link toc-highlight">一、分布式缓存</a><ul><li><a href="#1-redis-持久化" class="table-of-contents__link toc-highlight">1. Redis 持久化</a></li><li><a href="#2-redis-主从" class="table-of-contents__link toc-highlight">2. Redis 主从</a></li><li><a href="#3-redis-哨兵" class="table-of-contents__link toc-highlight">3. Redis 哨兵</a></li><li><a href="#4-redis-分片集群" class="table-of-contents__link toc-highlight">4. Redis 分片集群</a></li></ul></li><li><a href="#二多级缓存" class="table-of-contents__link toc-highlight">二、多级缓存</a><ul><li><a href="#1--jvm-进程缓存" class="table-of-contents__link toc-highlight">1.  JVM 进程缓存</a></li><li><a href="#2-lua-脚本语言" class="table-of-contents__link toc-highlight">2. Lua 脚本语言</a></li><li><a href="#3-多级缓存" class="table-of-contents__link toc-highlight">3. 多级缓存</a></li><li><a href="#4-缓存同步策略" class="table-of-contents__link toc-highlight">4. 缓存同步策略</a></li></ul></li><li><a href="#三redis-最佳实践使用经验" class="table-of-contents__link toc-highlight">三、Redis 最佳实践（使用经验）</a><ul><li><a href="#redis-键值设计" class="table-of-contents__link toc-highlight">Redis 键值设计</a></li><li><a href="#批处理优化" class="table-of-contents__link toc-highlight">批处理优化</a></li><li><a href="#服务端优化" class="table-of-contents__link toc-highlight">服务端优化</a></li><li><a href="#集群最佳实践" class="table-of-contents__link toc-highlight">集群最佳实践</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 HankLay, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.5b267564.js"></script>
<script src="/assets/js/main.2c7bbae3.js"></script>
</body>
</html>